<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VƒÇN PH√íNG UBND T·ªàNH L√ÇM ƒê·ªíNG - H·ªá th·ªëng Qu·∫£n l√Ω C√¥ng vi·ªác</title>
    <!-- T√≠ch h·ª£p Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T√≠ch h·ª£p th∆∞ vi·ªán SheetJS (xlsx) ƒë·ªÉ xu·∫•t file Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* T√πy ch·ªânh thanh cu·ªôn */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        /* ·∫®n c√°c view v√† modal m·∫∑c ƒë·ªãnh */
        .view, .modal-container { display: none; }
        /* Animation cho modal */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-container.flex { animation: fadeIn 0.3s ease-out; }
        .modal-content { animation: slideIn 0.3s ease-out; }
        #home-view-background {
            background-image: url('https://image.baophapluat.vn/w800/Uploaded/2025/vngtsu/2025_03_11/tinhlamdong-9972-2431.jpg');
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Thanh ƒëi·ªÅu h∆∞·ªõng ch√≠nh -->
    <nav id="navbar" class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <a href="#" class="text-sm sm:text-lg md:text-xl font-bold text-blue-700 flex items-center gap-2 uppercase">
                        VƒÇN PH√íNG UBND T·ªàNH L√ÇM ƒê·ªíNG
                    </a>
                </div>
                <div id="nav-links" class="flex items-center space-x-2 sm:space-x-4"></div>
            </div>
        </div>
    </nav>

    <main id="app" class="container mx-auto">
        <div id="home-view" class="view">
             <div id="home-view-background" class="relative h-[calc(100vh-4rem)] min-h-[600px] flex items-center">
                <div class="absolute inset-0 bg-gradient-to-r from-black/70 to-black/40"></div>
                <div class="relative z-10 w-full px-4 sm:px-6 lg:px-8">
                    <div class="max-w-3xl text-left">
                        <h2 class="text-lg font-semibold text-blue-300 uppercase tracking-widest">H·ªá th·ªëng th√¥ng tin</h2>
                        <h1 class="text-4xl md:text-6xl font-extrabold text-white my-3 leading-tight">ƒêi·ªÅu h√†nh v√† Qu·∫£n l√Ω C√¥ng vi·ªác</h1>
                        <p class="text-base md:text-lg text-gray-200 mb-8 max-w-2xl">
                            N·ªÅn t·∫£ng s·ªë gi√∫p t·ªëi ∆∞u h√≥a quy tr√¨nh x·ª≠ l√Ω vƒÉn b·∫£n, theo d√µi v√† ƒë√¥n ƒë·ªëc ti·∫øn ƒë·ªô c√¥ng vi·ªác m·ªôt c√°ch hi·ªáu qu·∫£, minh b·∫°ch.
                        </p>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button data-view="login-view" class="view-switcher w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-blue-700 transition duration-300 text-lg">ƒêƒÉng nh·∫≠p</button>
                            <button data-view="register-view" class="view-switcher w-full sm:w-auto bg-white bg-opacity-90 text-blue-700 font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-gray-200 transition duration-300 text-lg">ƒêƒÉng k√Ω</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="login-view" class="view max-w-md mx-auto p-4 sm:p-6 lg:p-8">
             <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">ƒêƒÉng nh·∫≠p</h2>
                <form id="login-form">
                    <div class="mb-4"><label for="login-email" class="block text-gray-700 font-semibold mb-2">Email</label><input type="email" id="login-email" class="w-full p-3 border border-gray-300 rounded-lg" required value="admin@taskflow.com"></div>
                    <div class="mb-6"><label for="login-password" class="block text-gray-700 font-semibold mb-2">M·∫≠t kh·∫©u</label><input type="password" id="login-password" class="w-full p-3 border border-gray-300 rounded-lg" required value="admin"></div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">ƒêƒÉng nh·∫≠p</button>
                    <p class="text-center mt-4">Ch∆∞a c√≥ t√†i kho·∫£n? <a href="#" data-view="register-view" class="view-switcher text-blue-600 hover:underline">ƒêƒÉng k√Ω ngay</a></p>
                </form>
            </div>
        </div>
        
        <div id="register-view" class="view max-w-md mx-auto p-4 sm:p-6 lg:p-8">
            <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">T·∫°o t√†i kho·∫£n</h2>
                <form id="register-form">
                     <div class="mb-4"><label for="register-name" class="block text-gray-700 font-semibold mb-2">H·ªç v√† t√™n</label><input type="text" id="register-name" class="w-full p-3 border border-gray-300 rounded-lg" required></div>
                     <div class="mb-4"><label for="register-email" class="block text-gray-700 font-semibold mb-2">Email</label><input type="email" id="register-email" class="w-full p-3 border border-gray-300 rounded-lg" required></div>
                     <div class="mb-6"><label for="register-password" class="block text-gray-700 font-semibold mb-2">M·∫≠t kh·∫©u</label><input type="password" id="register-password" class="w-full p-3 border border-gray-300 rounded-lg" required></div>
                     <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">ƒêƒÉng k√Ω</button>
                     <p class="text-center mt-4">ƒê√£ c√≥ t√†i kho·∫£n? <a href="#" data-view="login-view" class="view-switcher text-blue-600 hover:underline">ƒêƒÉng nh·∫≠p</a></p>
                </form>
            </div>
        </div>

        <div id="dashboard-view" class="view p-4 sm:p-6 lg:p-8">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-4">
                 <h2 id="dashboard-title" class="text-2xl sm:text-3xl font-bold text-gray-800">B·∫£ng ƒëi·ªÅu khi·ªÉn</h2>
                 <div id="dashboard-actions"></div>
            </div>
            <div class="mb-4 border-b border-gray-200 overflow-x-auto"><nav id="dashboard-tabs" class="-mb-px flex space-x-6 sm:space-x-8" aria-label="Tabs"></nav></div>
            <div id="tab-content"></div>
        </div>
    </main>

    <div id="modal-placeholder"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- GLOBAL STATE & CONSTANTS ---
        const app = document.getElementById('app');
        const navLinks = document.getElementById('nav-links');
        const modalPlaceholder = document.getElementById('modal-placeholder');

        const USERS_KEY = 'taskflow_pro_users';
        const TASKS_KEY = 'taskflow_pro_tasks';
        const DEPARTMENTS_KEY = 'taskflow_pro_departments';
        const SESSION_KEY = 'taskflow_pro_session';
        const TASK_CATEGORIES = ['Ph√°t tri·ªÉn', 'Thi·∫øt k·∫ø', 'Marketing', 'H·ªçp', 'Nghi√™n c·ª©u', 'Kh√°c'];
        const USER_ROLES = ['admin', 'L√£nh ƒë·∫°o VƒÉn ph√≤ng UBND t·ªânh', 'Tr∆∞·ªüng ph√≤ng', 'Ph√≥ Tr∆∞·ªüng ph√≤ng', 'Chuy√™n vi√™n', 'Nh√¢n vi√™n'];
        const TODAY = new Date(); TODAY.setHours(0, 0, 0, 0);

        let users = [];
        let tasks = [];
        let departments = [];
        let currentUser = null;
        let showTimeline = false; 

        // --- DATA MANAGEMENT ---
        const saveData = () => {
            localStorage.setItem(USERS_KEY, JSON.stringify(users));
            localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
            localStorage.setItem(DEPARTMENTS_KEY, JSON.stringify(departments));
        };

        const loadData = () => {
            users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
            tasks = JSON.parse(localStorage.getItem(TASKS_KEY)) || [];
            departments = JSON.parse(localStorage.getItem(DEPARTMENTS_KEY)) || [];
            currentUser = JSON.parse(sessionStorage.getItem(SESSION_KEY)) || null;
        };

        const createDefaultAdmin = () => {
            if (users.find(u => u.role === 'admin')) return;
            const defaultDept = { id: `dept_${Date.now()}`, name: 'Ch∆∞a ph√¢n lo·∫°i', description: 'Ph√≤ng ban m·∫∑c ƒë·ªãnh'};
            departments.push(defaultDept);
            users.push({ id: `user_${Date.now()}`, name: 'Qu·∫£n tr·ªã vi√™n', email: 'admin@taskflow.com', password: 'admin', role: 'admin', departmentId: defaultDept.id, position: 'Qu·∫£n tr·ªã h·ªá th·ªëng', phone: '0123456789', createdAt: new Date().toISOString() });
            saveData();
            console.log('T√†i kho·∫£n admin v√† ph√≤ng ban m·∫∑c ƒë·ªãnh ƒë√£ ƒë∆∞·ª£c t·∫°o.');
        };

        // --- UI UTILITIES ---
        const getRoleClass = (r) => ({'admin':'bg-purple-200 text-purple-800','L√£nh ƒë·∫°o VƒÉn ph√≤ng UBND t·ªânh':'bg-rose-200 text-rose-800','Tr∆∞·ªüng ph√≤ng':'bg-red-200 text-red-800','Ph√≥ Tr∆∞·ªüng ph√≤ng':'bg-orange-200 text-orange-800','Chuy√™n vi√™n':'bg-blue-200 text-blue-800','Nh√¢n vi√™n':'bg-gray-200 text-gray-800'}[r]||'bg-gray-200 text-gray-800');
        const getPriorityClass = (p) => ({'Kh·∫©n c·∫•p':'bg-red-100 text-red-800','Cao':'bg-orange-100 text-orange-800','Trung b√¨nh':'bg-blue-100 text-blue-800','Th·∫•p':'bg-gray-100 text-gray-800'}[p] || 'bg-gray-100 text-gray-800');
        const getStatusClass = (s) => ({'Ho√†n th√†nh':'bg-green-100 text-green-800','ƒêang th·ª±c hi·ªán':'bg-indigo-100 text-indigo-800','ƒê√£ h·ªßy':'bg-pink-100 text-pink-800','Ch∆∞a b·∫Øt ƒë·∫ßu':'bg-gray-100 text-gray-800'}[s] || 'bg-gray-100 text-gray-800');
        const generateAvatar = (name = '?', size = 'w-10 h-10') => { const initials = name.split(' ').map(n=>n[0]).join('').toUpperCase(); const colors = ['bg-blue-500', 'bg-green-500', 'bg-indigo-500', 'bg-purple-500', 'bg-pink-500', 'bg-red-500']; const color = colors[initials.charCodeAt(0) % colors.length]; return `<div class="${size} ${color} rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">${initials}</div>`; };
        const showView = (viewId) => { document.querySelectorAll('.view').forEach(v => v.style.display = 'none'); document.getElementById(viewId).style.display = 'block'; };
        const showModal = (content) => { modalPlaceholder.innerHTML = content; modalPlaceholder.querySelector('.modal-container').style.display = 'flex'; modalPlaceholder.querySelectorAll('.modal-close').forEach(el => el.addEventListener('click', closeModal)); modalPlaceholder.querySelector('.modal-container').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); }); };
        const closeModal = () => { if(modalPlaceholder.querySelector('.modal-container')) modalPlaceholder.querySelector('.modal-container').style.display = 'none'; };
        const showNotification = (message, isError = false) => { const color = isError ? 'bg-red-500' : 'bg-green-500'; const notif = document.createElement('div'); notif.className = `fixed bottom-5 right-5 ${color} text-white py-2 px-4 rounded-lg shadow-lg z-50`; notif.textContent = message; document.body.appendChild(notif); setTimeout(() => notif.remove(), 3000); };
        const hasAdminRights = (user) => user && (user.role === 'admin' || user.role === 'L√£nh ƒë·∫°o VƒÉn ph√≤ng UBND t·ªânh');

        // --- UI RENDERING ---
        const updateUI = () => {
            const mainContainer = document.querySelector('main');
            if (currentUser) {
                mainContainer.classList.remove('p-0');
                navLinks.innerHTML = `<span class="font-semibold text-gray-700 hidden sm:block">Ch√†o, ${currentUser.name}!</span><div id="user-avatar" class="cursor-pointer">${generateAvatar(currentUser.name, 'w-9 h-9')}</div><button id="logout-btn" class="bg-red-100 text-red-700 font-bold py-2 px-3 text-sm rounded-lg hover:bg-red-200 transition">ƒêƒÉng xu·∫•t</button>`;
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
                renderDashboard();
                showView('dashboard-view');
            } else {
                mainContainer.classList.add('p-0');
                mainContainer.classList.remove('p-4', 'sm:p-6', 'lg:p-8');
                navLinks.innerHTML = `<a href="#" data-view="login-view" class="view-switcher text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">ƒêƒÉng nh·∫≠p</a><a href="#" data-view="register-view" class="view-switcher bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition text-sm">ƒêƒÉng k√Ω</a>`;
                showView('home-view');
            }
            setupViewSwitcherListeners();
        };

        const renderDashboard = () => {
            const canAdmin = hasAdminRights(currentUser);
            document.getElementById('dashboard-title').textContent = canAdmin ? 'B·∫£ng ƒëi·ªÅu khi·ªÉn Qu·∫£n tr·ªã' : 'B·∫£ng ƒëi·ªÅu khi·ªÉn';
            const tabsContainer = document.getElementById('dashboard-tabs');
            let tabsHTML = `<a href="#" class="dashboard-tab border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="tasks">Qu·∫£n l√Ω C√¥ng vi·ªác</a>`;
            if (canAdmin) {
                tabsHTML += `<a href="#" class="dashboard-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="users">Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</a>`;
                tabsHTML += `<a href="#" class="dashboard-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="departments">Qu·∫£n l√Ω Ph√≤ng ban</a>`;
            }
            tabsHTML += `<a href="#" class="dashboard-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="stats">Th·ªëng k√™</a>`;
            tabsContainer.innerHTML = tabsHTML;
            renderTabContent('tasks'); 
            tabsContainer.querySelectorAll('.dashboard-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    tabsContainer.querySelectorAll('.dashboard-tab').forEach(t => { t.classList.replace('border-blue-500','border-transparent'); t.classList.replace('text-blue-600','text-gray-500');});
                    e.target.classList.replace('border-transparent','border-blue-500'); e.target.classList.replace('text-gray-500','text-blue-600');
                    renderTabContent(e.target.dataset.tab);
                });
            });
        };

        const renderTabContent = (tabId) => {
            const contentContainer = document.getElementById('tab-content');
            const canAdmin = hasAdminRights(currentUser);
            if (tabId === 'tasks') { contentContainer.innerHTML = getTasksViewHTML(); updateAllTaskStatuses(); renderTasksTable(); setupTaskViewListeners(); } 
            else if (tabId === 'users' && canAdmin) { contentContainer.innerHTML = getUsersViewHTML(); renderUsersTable(); setupUserViewListeners(); } 
            else if (tabId === 'departments' && canAdmin) { contentContainer.innerHTML = getDepartmentsViewHTML(); renderDepartmentsTable(); setupDepartmentViewListeners(); } 
            else if (tabId === 'stats') { contentContainer.innerHTML = canAdmin ? getAdminStatsViewHTML() : getMemberStatsViewHTML(); if (canAdmin) renderAdminStats(); else renderMemberStats(); }
        };

        const getTasksViewHTML = () => {
            const canAdmin = hasAdminRights(currentUser);
            return `<div class="bg-white p-4 rounded-lg shadow-sm mb-4"><div class="grid grid-cols-1 sm:grid-cols-2 ${canAdmin ? 'lg:grid-cols-5' : 'lg:grid-cols-4'} gap-4 items-center"><input type="text" id="task-search" placeholder="T√¨m ki·∫øm c√¥ng vi·ªác, vƒÉn b·∫£n..." class="w-full p-2 border rounded-lg ${canAdmin ? 'lg:col-span-1' : ''}"><select id="task-filter-status" class="w-full p-2 border rounded-lg"><option value="">T·∫•t c·∫£ Tr·∫°ng th√°i</option>${['Ch∆∞a b·∫Øt ƒë·∫ßu', 'ƒêang th·ª±c hi·ªán', 'Ho√†n th√†nh', 'ƒê√£ h·ªßy'].map(s => `<option value="${s}">${s}</option>`).join('')}</select><select id="task-sort" class="w-full p-2 border rounded-lg"><option value="default">S·∫Øp x·∫øp m·∫∑c ƒë·ªãnh</option><option value="orderNumber_asc">Theo STT</option><option value="documentNumber_asc">Theo S·ªë vƒÉn b·∫£n</option></select>${canAdmin ? `<select id="task-filter-category" class="w-full p-2 border rounded-lg"><option value="">T·∫•t c·∫£ Danh m·ª•c</option>${TASK_CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('')}</select>` : ''}<button id="toggle-timeline-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg text-sm whitespace-nowrap">${showTimeline ? '·∫®n' : 'Hi·ªán'} Ti·∫øn tr√¨nh</button></div></div><div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2"><button id="add-task-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">+ Th√™m C√¥ng vi·ªác</button>${canAdmin ? `<button id="export-excel-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300">üì• Xu·∫•t Excel</button>` : ''}</div><div class="bg-white rounded-lg shadow-md overflow-x-auto"><table class="w-full min-w-max text-left"><thead class="bg-gray-50"></thead><tbody id="tasks-table-body"></tbody></table></div>`;
        };
        const getUsersViewHTML = () => `<div class="bg-white p-4 rounded-lg shadow-sm mb-4"><input type="text" id="user-search" placeholder="T√¨m theo t√™n, email, ph√≤ng ban..." class="w-full md:w-1/3 p-2 border rounded-lg"></div><div class="flex justify-start items-center mb-4"><button id="add-user-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">+ Th√™m Ng∆∞·ªùi d√πng</button></div><div class="bg-white rounded-lg shadow-md overflow-x-auto"><table class="w-full min-w-max text-left"><thead class="bg-gray-50"></thead><tbody id="users-table-body"></tbody></table></div>`;
        const getDepartmentsViewHTML = () => `<div class="flex justify-start items-center mb-4"><button id="add-department-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">+ Th√™m Ph√≤ng ban</button></div><div class="bg-white rounded-lg shadow-md overflow-x-auto"><table class="w-full min-w-max text-left"><thead class="bg-gray-50"></thead><tbody id="departments-table-body"></tbody></table></div>`;
        const getAdminStatsViewHTML = () => `<div id="stats-view" class="space-y-8"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-lg font-semibold text-gray-600">T·ªïng s·ªë ng∆∞·ªùi d√πng</h3><p id="stats-total-users" class="text-4xl font-bold text-blue-600">0</p></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-lg font-semibold text-gray-600">T·ªïng s·ªë c√¥ng vi·ªác</h3><p id="stats-total-tasks" class="text-4xl font-bold text-green-600">0</p></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-lg font-semibold text-gray-600">T·ªïng s·ªë ph√≤ng ban</h3><p id="stats-total-departments" class="text-4xl font-bold text-purple-600">0</p></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="space-y-8"><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-xl font-bold text-gray-800 mb-4">C√¥ng vi·ªác theo Tr·∫°ng th√°i</h3><div id="stats-tasks-by-status" class="space-y-3"></div></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-xl font-bold text-gray-800 mb-4">C√¥ng vi·ªác theo M·ª©c ƒë·ªô ∆∞u ti√™n</h3><div id="stats-tasks-by-priority" class="space-y-3"></div></div></div><div class="space-y-8"><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-xl font-bold text-gray-800 mb-4">Nh√¢n s·ª± theo Ph√≤ng ban</h3><div id="stats-users-by-department" class="space-y-3"></div></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-xl font-bold text-gray-800 mb-4">Th√†nh vi√™n t√≠ch c·ª±c nh·∫•t</h3><div id="stats-top-users" class="space-y-4"></div></div></div></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-xl font-bold text-gray-800 mb-4">Danh s√°ch c√¥ng vi·ªác chi ti·∫øt</h3><div class="overflow-x-auto"><table class="w-full min-w-max text-left"><thead class="bg-gray-50"></thead><tbody id="stats-task-list-body"></tbody></table></div></div></div>`;
        const getMemberStatsViewHTML = () => `<div id="stats-view" class="space-y-8"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-lg font-semibold text-gray-600">T·ªïng c√¥ng vi·ªác c·ªßa b·∫°n</h3><p id="stats-member-total-tasks" class="text-4xl font-bold text-green-600">0</p></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-lg font-semibold text-gray-600">C√¥ng vi·ªác ƒë√£ ho√†n th√†nh</h3><p id="stats-member-completed-tasks" class="text-4xl font-bold text-indigo-600">0</p></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-xl font-bold text-gray-800 mb-4">C√¥ng vi·ªác theo Tr·∫°ng th√°i</h3><div id="stats-member-tasks-by-status" class="space-y-3"></div></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-xl font-bold text-gray-800 mb-4">C√¥ng vi·ªác theo M·ª©c ƒë·ªô ∆∞u ti√™n</h3><div id="stats-member-tasks-by-priority" class="space-y-3"></div></div></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-xl font-bold text-gray-800 mb-4">Danh s√°ch c√¥ng vi·ªác chi ti·∫øt</h3><div class="overflow-x-auto"><table class="w-full min-w-max text-left"><thead class="bg-gray-50"></thead><tbody id="stats-task-list-body"></tbody></table></div></div></div>`;
        const generateTimelineHTML = (task) => { const start = task.startDate ? new Date(task.startDate) : null; const end = task.endDate ? new Date(task.endDate) : null; if (!start || !end || start > end) return '<div class="mt-2 text-xs text-gray-400">Kh√¥ng ƒë·ªß d·ªØ li·ªáu ng√†y ƒë·ªÉ hi·ªÉn th·ªã ti·∫øn tr√¨nh.</div>'; const totalDuration = (end - start); const elapsedDuration = (TODAY - start); let progressPercent = 0; if (totalDuration > 0) progressPercent = Math.min(100, Math.max(0, (elapsedDuration / totalDuration) * 100)); else if (TODAY >= start) progressPercent = 100; let color = 'bg-yellow-400'; const isOverdue = TODAY > end && task.status !== 'Ho√†n th√†nh'; if (task.status === 'Ho√†n th√†nh') color = 'bg-blue-500'; else if (isOverdue) color = 'bg-red-500'; return `<div class="mt-3"><div class="flex justify-between text-xs text-gray-500 mb-1"><span class="font-semibold text-green-600">${task.startDate}</span><span class="font-bold">${progressPercent.toFixed(0)}%</span><span class="font-semibold text-gray-600">${task.endDate}</span></div><div class="relative h-2 w-full bg-gray-200 rounded-full" title="Ti·∫øn tr√¨nh: ${progressPercent.toFixed(0)}%"><div class="h-full rounded-full ${color}" style="width: ${progressPercent}%;"></div></div></div>`; };
        const renderTasksTable = () => {
            const canAdmin = hasAdminRights(currentUser);
            const tableBody = document.querySelector('#tasks-table-body'); if (!tableBody) return;
            const tableHead = tableBody.previousElementSibling;
            tableHead.innerHTML = `<tr><th class="p-2 sm:p-4 font-semibold text-gray-700">STT</th><th class="p-2 sm:p-4 font-semibold text-gray-700">C√¥ng vi·ªác & VƒÉn b·∫£n</th>${canAdmin ? '<th class="p-2 sm:p-4 font-semibold text-gray-700">G√°n cho</th>' : ''}<th class="p-2 sm:p-4 font-semibold text-gray-700">Tr·∫°ng th√°i</th><th class="p-2 sm:p-4 font-semibold text-gray-700">Ng√†y</th><th class="p-2 sm:p-4 font-semibold text-gray-700 text-center">H√†nh ƒë·ªông</th></tr>`;
            const searchTerm = document.getElementById('task-search').value.toLowerCase();
            const statusFilter = document.getElementById('task-filter-status').value;
            const sortOption = document.getElementById('task-sort').value;
            let filteredTasks = canAdmin ? [...tasks] : tasks.filter(t => t.assignedTo === currentUser.id || t.createdBy === currentUser.id);
            filteredTasks = filteredTasks.filter(t => (t.title.toLowerCase().includes(searchTerm) || (t.documentNumber && t.documentNumber.toLowerCase().includes(searchTerm)) || (t.documentSummary && t.documentSummary.toLowerCase().includes(searchTerm))) && (!statusFilter || t.status === statusFilter));
            if (sortOption === 'orderNumber_asc') filteredTasks.sort((a, b) => (parseInt(a.orderNumber) || Infinity) - (parseInt(b.orderNumber) || Infinity));
            else if (sortOption === 'documentNumber_asc') filteredTasks.sort((a, b) => (a.documentNumber || '').localeCompare(b.documentNumber || ''));
            tableBody.innerHTML = '';
            if (filteredTasks.length === 0) { tableBody.innerHTML = `<tr><td colspan="${canAdmin ? 6:5}" class="text-center p-8 text-gray-500">Kh√¥ng t√¨m th·∫•y c√¥ng vi·ªác n√†o.</td></tr>`; return; }
            filteredTasks.forEach(task => { const assignedUser = users.find(u => u.id === task.assignedTo); const tr = document.createElement('tr'); tr.className = 'border-b border-gray-200 hover:bg-gray-50'; const timelineHTML = showTimeline ? generateTimelineHTML(task) : ''; tr.innerHTML = `<td class="p-2 sm:p-4 align-top font-semibold text-gray-700">${task.orderNumber || ''}</td><td class="p-2 sm:p-4 align-top"><div class="font-bold text-gray-800">${task.title}</div>${task.documentNumber ? `<div class="mt-1"><span class="font-semibold text-sm">VB:</span> <span class="text-sm text-gray-600">${task.documentNumber}</span> <button class="view-doc-btn text-blue-500 text-xs hover:underline" data-id="${task.id}">(Xem)</button></div><div class="text-sm text-gray-500 mt-1 line-clamp-2">${task.documentSummary || ''}</div>` : ''}${timelineHTML}</td>${canAdmin ? `<td class="p-2 sm:p-4 align-top"><div class="flex items-center gap-2">${generateAvatar(assignedUser?.name, 'w-8 h-8')}<span class="text-sm">${assignedUser?.name || 'N/A'}</span></div></td>` : ''}<td class="p-2 sm:p-4 align-top"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(task.status)}">${task.status}</span></td><td class="p-2 sm:p-4 text-sm text-gray-600 align-top"><div>Bƒê: ${task.startDate || 'N/A'}</div><div>HT: ${task.endDate || 'N/A'}</div></td><td class="p-2 sm:p-4 text-center align-top"><button data-id="${task.id}" class="edit-task-btn p-2 text-blue-600 hover:bg-blue-100 rounded-full">S·ª≠a</button><button data-id="${task.id}" class="delete-task-btn p-2 text-red-600 hover:bg-red-100 rounded-full">X√≥a</button></td>`; tableBody.appendChild(tr); });
        };
        const renderUsersTable = () => { /* ... full function ... */ };
        const renderDepartmentsTable = () => { /* ... full function ... */ };
        const renderAdminStats = () => { /* ... full function ... */ };
        const renderMemberStats = () => { /* ... full function ... */ };
        const renderStatsTaskList = (isAdmin) => { /* ... full function ... */ };

        // --- CORE LOGIC & HANDLERS ---
        const getAutoTaskStatus = (task) => { /* ... full function ... */ };
        const updateAllTaskStatuses = () => { /* ... full function ... */ };
        const handleLogin = (e) => { /* ... full function ... */ };
        const handleLogout = () => { /* ... full function ... */ };
        const handleRegister = (e) => { /* ... full function ... */ };
        const openTaskModal = (task = null) => { /* ... full function ... */ };
        const handleTaskSubmit = (e) => { /* ... full function ... */ };
        const deleteTask = (taskId) => { /* ... full function ... */ };
        const showDocumentDetailModal = (taskId) => { /* ... full function ... */ };
        const openUserModal = (user = null) => { /* ... full function ... */ };
        const handleUserSubmit = (e) => { /* ... full function ... */ };
        const deleteUser = (userId) => { /* ... full function ... */ };
        const openDepartmentModal = (dept = null) => { /* ... full function ... */ };
        const handleDepartmentSubmit = (e) => { /* ... full function ... */ };
        const deleteDepartment = (deptId) => { /* ... full function ... */ };
        const exportToExcel = () => { /* ... full function ... */ };
        
        // --- EVENT LISTENER SETUP ---
        function setupGlobalListeners() {
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.body.addEventListener('click', e => {
                const target = e.target;
                if(target.closest('.edit-task-btn')) openTaskModal(tasks.find(t => t.id === target.closest('.edit-task-btn').dataset.id));
                if(target.closest('.delete-task-btn')) deleteTask(target.closest('.delete-task-btn').dataset.id);
                if(target.closest('.view-doc-btn')) showDocumentDetailModal(target.closest('.view-doc-btn').dataset.id);
                if(target.closest('.edit-user-btn')) openUserModal(users.find(u => u.id === target.closest('.edit-user-btn').dataset.id));
                if(target.closest('.delete-user-btn')) deleteUser(target.closest('.delete-user-btn').dataset.id);
                if(target.closest('.edit-department-btn')) openDepartmentModal(departments.find(d => d.id === target.closest('.edit-department-btn').dataset.id));
                if(target.closest('.delete-department-btn')) deleteDepartment(target.closest('.delete-department-btn').dataset.id);
            });
        }
        
        function setupViewSwitcherListeners() { document.querySelectorAll('.view-switcher').forEach(button => { const listener = (e) => { e.preventDefault(); showView(e.target.closest('.view-switcher').dataset.view); }; button.removeEventListener('click', listener); button.addEventListener('click', listener); }); }
        
        function setupTaskViewListeners() {
            const addTaskBtn = document.getElementById('add-task-btn'); if(addTaskBtn) addTaskBtn.addEventListener('click', () => openTaskModal());
            const exportBtn = document.getElementById('export-excel-btn'); if(exportBtn) exportBtn.addEventListener('click', exportToExcel);
            const toggleTimelineBtn = document.getElementById('toggle-timeline-btn'); if(toggleTimelineBtn) toggleTimelineBtn.addEventListener('click', () => { showTimeline = !showTimeline; renderTasksTable(); toggleTimelineBtn.textContent = `${showTimeline ? '·∫®n' : 'Hi·ªán'} Ti·∫øn tr√¨nh`; toggleTimelineBtn.classList.toggle('bg-blue-100', showTimeline); toggleTimelineBtn.classList.toggle('text-blue-700', showTimeline); });
            const searchInput = document.getElementById('task-search'); if(searchInput) searchInput.addEventListener('input', renderTasksTable);
            const statusFilter = document.getElementById('task-filter-status'); if(statusFilter) statusFilter.addEventListener('change', renderTasksTable);
            const sortInput = document.getElementById('task-sort'); if(sortInput) sortInput.addEventListener('change', renderTasksTable);
            const categoryFilter = document.getElementById('task-filter-category'); if (categoryFilter) categoryFilter.addEventListener('change', renderTasksTable);
        }
        function attachAutoStatusListenerToForm(formId) {
            const form = document.getElementById(formId);
            const startDateInput = form.querySelector('[name="startDate"]');
            const endDateInput = form.querySelector('[name="endDate"]');
            const statusSelect = form.querySelector('[name="status"]');
            const updateStatus = () => { const tempTask = { startDate: startDateInput.value, endDate: endDateInput.value, status: statusSelect.value }; const newStatus = getAutoTaskStatus(tempTask); if (statusSelect.value !== newStatus && statusSelect.value !== 'Ho√†n th√†nh' && statusSelect.value !== 'ƒê√£ h·ªßy') { statusSelect.value = newStatus; } };
            startDateInput.addEventListener('change', updateStatus);
            endDateInput.addEventListener('change', updateStatus);
            form.addEventListener('submit', handleTaskSubmit);
        };
        function setupUserViewListeners() { document.getElementById('add-user-btn').addEventListener('click', () => openUserModal()); document.getElementById('user-search').addEventListener('input', renderUsersTable); }
        function setupDepartmentViewListeners() { document.getElementById('add-department-btn').addEventListener('click', () => openDepartmentModal()); }

        // --- APP INITIALIZATION ---
        const init = () => {
            loadData(); createDefaultAdmin(); setupGlobalListeners(); updateUI();
            setInterval(() => {
                if(currentUser){
                    console.log('Running periodic task status update...');
                    updateAllTaskStatuses();
                }
            }, 1000 * 60 * 60);
        };

        init();
    });
    </script>
</body>
</html>
