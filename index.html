<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VƒÇN PH√íNG UBND T·ªàNH L√ÇM ƒê·ªíNG - H·ªá th·ªëng Qu·∫£n l√Ω C√¥ng vi·ªác</title>
    <!-- T√≠ch h·ª£p Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T√≠ch h·ª£p th∆∞ vi·ªán SheetJS (xlsx) ƒë·ªÉ xu·∫•t file Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* T√πy ch·ªânh thanh cu·ªôn */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        /* ·∫®n c√°c view v√† modal m·∫∑c ƒë·ªãnh */
        .view, .modal-container { display: none; }
        /* Animation cho modal */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-container.flex { animation: fadeIn 0.3s ease-out; }
        .modal-content { animation: slideIn 0.3s ease-out; }
        /* *** UPDATED: Styles for new homepage with public URL *** */
        #home-view-background {
            background-image: url('https://image.baophapluat.vn/w800/Uploaded/2025/vngtsu/2025_03_11/tinhlamdong-9972-2431.jpg');
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Thanh ƒëi·ªÅu h∆∞·ªõng ch√≠nh -->
    <nav id="navbar" class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <!-- *** UPDATED: Application Title *** -->
                    <a href="#" class="text-lg sm:text-xl font-bold text-blue-700 flex items-center gap-2 uppercase">
                        VƒÇN PH√íNG UBND T·ªàNH L√ÇM ƒê·ªíNG
                    </a>
                </div>
                <div id="nav-links" class="flex items-center space-x-4"></div>
            </div>
        </div>
    </nav>

    <!-- *** UPDATED: Main container class for better padding control *** -->
    <main id="app" class="container mx-auto">
        <!-- *** UPDATED: Homepage View Layout *** -->
        <div id="home-view" class="view">
            <div id="home-view-background" class="relative h-[calc(100vh-4rem)] min-h-[600px] flex items-center">
                <div class="absolute inset-0 bg-gradient-to-r from-black/70 to-black/40"></div>
                <div class="relative z-10 w-full px-4 sm:px-6 lg:px-8">
                    <div class="max-w-3xl text-left">
                        <h2 class="text-lg font-semibold text-blue-300 uppercase tracking-widest">H·ªá th·ªëng th√¥ng tin</h2>
                        <h1 class="text-4xl md:text-6xl font-extrabold text-white my-3 leading-tight">ƒêi·ªÅu h√†nh v√† Qu·∫£n l√Ω C√¥ng vi·ªác</h1>
                        <p class="text-base md:text-lg text-gray-200 mb-8 max-w-2xl">
                            N·ªÅn t·∫£ng s·ªë gi√∫p t·ªëi ∆∞u h√≥a quy tr√¨nh x·ª≠ l√Ω vƒÉn b·∫£n, theo d√µi v√† ƒë√¥n ƒë·ªëc ti·∫øn ƒë·ªô c√¥ng vi·ªác m·ªôt c√°ch hi·ªáu qu·∫£, minh b·∫°ch.
                        </p>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button data-view="login-view" class="view-switcher w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-blue-700 transition duration-300 text-lg">ƒêƒÉng nh·∫≠p</button>
                            <button data-view="register-view" class="view-switcher w-full sm:w-auto bg-white bg-opacity-90 text-blue-700 font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-gray-200 transition duration-300 text-lg">ƒêƒÉng k√Ω</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- *** UPDATED: Added padding to internal views *** -->
        <div id="login-view" class="view max-w-md mx-auto p-4 sm:p-6 lg:p-8">
             <div class="bg-white p-8 rounded-lg shadow-xl">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">ƒêƒÉng nh·∫≠p</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-gray-700 font-semibold mb-2">Email</label>
                        <input type="email" id="login-email" class="w-full p-3 border border-gray-300 rounded-lg" required value="admin@taskflow.com">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-gray-700 font-semibold mb-2">M·∫≠t kh·∫©u</label>
                        <input type="password" id="login-password" class="w-full p-3 border border-gray-300 rounded-lg" required value="admin">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">ƒêƒÉng nh·∫≠p</button>
                    <p class="text-center mt-4">Ch∆∞a c√≥ t√†i kho·∫£n? <a href="#" data-view="register-view" class="view-switcher text-blue-600 hover:underline">ƒêƒÉng k√Ω ngay</a></p>
                </form>
            </div>
        </div>
        
        <div id="register-view" class="view max-w-md mx-auto p-4 sm:p-6 lg:p-8">
            <div class="bg-white p-8 rounded-lg shadow-xl">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">T·∫°o t√†i kho·∫£n</h2>
                <form id="register-form">
                     <div class="mb-4">
                        <label for="register-name" class="block text-gray-700 font-semibold mb-2">H·ªç v√† t√™n</label>
                        <input type="text" id="register-name" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <div class="mb-4">
                        <label for="register-email" class="block text-gray-700 font-semibold mb-2">Email</label>
                        <input type="email" id="register-email" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <div class="mb-6">
                        <label for="register-password" class="block text-gray-700 font-semibold mb-2">M·∫≠t kh·∫©u</label>
                        <input type="password" id="register-password" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">ƒêƒÉng k√Ω</button>
                     <p class="text-center mt-4">ƒê√£ c√≥ t√†i kho·∫£n? <a href="#" data-view="login-view" class="view-switcher text-blue-600 hover:underline">ƒêƒÉng nh·∫≠p</a></p>
                </form>
            </div>
        </div>

        <div id="dashboard-view" class="view p-4 sm:p-6 lg:p-8">
            <div class="flex items-center justify-between mb-6">
                 <h2 id="dashboard-title" class="text-3xl font-bold text-gray-800">B·∫£ng ƒëi·ªÅu khi·ªÉn</h2>
                 <div id="dashboard-actions"></div>
            </div>

            <div class="mb-4 border-b border-gray-200">
                <nav id="dashboard-tabs" class="-mb-px flex space-x-8" aria-label="Tabs">
                </nav>
            </div>

            <div id="tab-content">
            </div>
        </div>
    </main>

    <div id="modal-placeholder"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- GLOBAL STATE & CONSTANTS ---
        const app = document.getElementById('app');
        const navLinks = document.getElementById('nav-links');
        const modalPlaceholder = document.getElementById('modal-placeholder');

        const USERS_KEY = 'taskflow_pro_users';
        const TASKS_KEY = 'taskflow_pro_tasks';
        const DEPARTMENTS_KEY = 'taskflow_pro_departments';
        const SESSION_KEY = 'taskflow_pro_session';
        const TASK_CATEGORIES = ['Ph√°t tri·ªÉn', 'Thi·∫øt k·∫ø', 'Marketing', 'H·ªçp', 'Nghi√™n c·ª©u', 'Kh√°c'];
        // *** UPDATED: User Roles Constant ***
        const USER_ROLES = ['admin', 'L√£nh ƒë·∫°o VƒÉn ph√≤ng UBND t·ªânh', 'Tr∆∞·ªüng ph√≤ng', 'Ph√≥ Tr∆∞·ªüng ph√≤ng', 'Chuy√™n vi√™n', 'Nh√¢n vi√™n'];
        const TODAY = new Date(); 
        TODAY.setHours(0, 0, 0, 0);

        let users = [];
        let tasks = [];
        let departments = [];
        let currentUser = null;
        let showTimeline = false; 

        // --- DATA MANAGEMENT ---
        const saveData = () => {
            localStorage.setItem(USERS_KEY, JSON.stringify(users));
            localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
            localStorage.setItem(DEPARTMENTS_KEY, JSON.stringify(departments));
        };

        const loadData = () => {
            users = JSON.parse(localStorage.getItem(USERS_KEY)) || [];
            tasks = JSON.parse(localStorage.getItem(TASKS_KEY)) || [];
            departments = JSON.parse(localStorage.getItem(DEPARTMENTS_KEY)) || [];
            currentUser = JSON.parse(sessionStorage.getItem(SESSION_KEY)) || null;
        };

        const createDefaultAdmin = () => {
            if (users.find(u => u.role === 'admin')) return;
            const defaultDept = { id: `dept_${Date.now()}`, name: 'Ch∆∞a ph√¢n lo·∫°i', description: 'Ph√≤ng ban m·∫∑c ƒë·ªãnh'};
            departments.push(defaultDept);

            users.push({
                id: `user_${Date.now()}`,
                name: 'Qu·∫£n tr·ªã vi√™n',
                email: 'admin@taskflow.com',
                password: 'admin',
                role: 'admin',
                departmentId: defaultDept.id,
                position: 'Qu·∫£n tr·ªã h·ªá th·ªëng',
                phone: '0123456789',
                createdAt: new Date().toISOString()
            });
            saveData();
            console.log('T√†i kho·∫£n admin v√† ph√≤ng ban m·∫∑c ƒë·ªãnh ƒë√£ ƒë∆∞·ª£c t·∫°o.');
        };

        // --- UI UTILITIES ---
        const getPriorityClass = (p) => ({'Kh·∫©n c·∫•p':'bg-red-100 text-red-800','Cao':'bg-orange-100 text-orange-800','Trung b√¨nh':'bg-blue-100 text-blue-800','Th·∫•p':'bg-gray-100 text-gray-800'}[p] || 'bg-gray-100 text-gray-800');
        const getStatusClass = (s) => ({'Ho√†n th√†nh':'bg-green-100 text-green-800','ƒêang th·ª±c hi·ªán':'bg-indigo-100 text-indigo-800','ƒê√£ h·ªßy':'bg-pink-100 text-pink-800','Ch∆∞a b·∫Øt ƒë·∫ßu':'bg-gray-100 text-gray-800'}[s] || 'bg-gray-100 text-gray-800');
        
        // *** UPDATED: Role color helper function ***
        const getRoleClass = (role) => ({
            'admin': 'bg-purple-200 text-purple-800',
            'L√£nh ƒë·∫°o VƒÉn ph√≤ng UBND t·ªânh': 'bg-rose-200 text-rose-800',
            'Tr∆∞·ªüng ph√≤ng': 'bg-red-200 text-red-800',
            'Ph√≥ Tr∆∞·ªüng ph√≤ng': 'bg-orange-200 text-orange-800',
            'Chuy√™n vi√™n': 'bg-blue-200 text-blue-800',
            'Nh√¢n vi√™n': 'bg-gray-200 text-gray-800'
        }[role] || 'bg-gray-200 text-gray-800');
        
        const generateAvatar = (name = '?', size = 'w-10 h-10') => {
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
            const colors = ['bg-blue-500', 'bg-green-500', 'bg-indigo-500', 'bg-purple-500', 'bg-pink-500', 'bg-red-500'];
            const color = colors[initials.charCodeAt(0) % colors.length];
            return `<div class="${size} ${color} rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">${initials}</div>`;
        };
        
        // --- VIEW & MODAL MANAGEMENT ---
        const showView = (viewId) => {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            const view = document.getElementById(viewId);
            if (view) view.style.display = 'block';
        };

        const showModal = (content) => {
            modalPlaceholder.innerHTML = content;
            const modalContainer = modalPlaceholder.querySelector('.modal-container');
            modalContainer.style.display = 'flex';
            modalContainer.querySelectorAll('.modal-close').forEach(el => el.addEventListener('click', closeModal));
            modalContainer.addEventListener('click', e => {
                if (e.target === modalContainer) closeModal();
            });
        };

        const closeModal = () => {
            const modalContainer = modalPlaceholder.querySelector('.modal-container');
            if (modalContainer) modalContainer.style.display = 'none';
            modalPlaceholder.innerHTML = '';
        };

        const showNotification = (message, isError = false) => {
            const color = isError ? 'bg-red-500' : 'bg-green-500';
            const notif = document.createElement('div');
            notif.className = `fixed bottom-5 right-5 ${color} text-white py-2 px-4 rounded-lg shadow-lg animate-pulse z-50`;
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        };

        // *** NEW: Helper to check for admin-level roles ***
        const hasAdminRights = (user) => {
            if (!user) return false;
            return user.role === 'admin' || user.role === 'L√£nh ƒë·∫°o VƒÉn ph√≤ng UBND t·ªânh';
        }
        
        // --- UI RENDERING ---
        const updateUI = () => {
            const appContainer = document.getElementById('app');
            const mainContainer = document.querySelector('main');
            if (currentUser) {
                mainContainer.classList.add('p-4', 'sm:p-6', 'lg:p-8');
                navLinks.innerHTML = `<span class="font-semibold text-gray-700 hidden sm:block">Ch√†o, ${currentUser.name}!</span><div id="user-avatar" class="cursor-pointer">${generateAvatar(currentUser.name, 'w-9 h-9')}</div><button id="logout-btn" class="bg-red-100 text-red-700 font-bold py-2 px-4 rounded-lg hover:bg-red-200 transition text-sm">ƒêƒÉng xu·∫•t</button>`;
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
                renderDashboard();
                showView('dashboard-view');
            } else {
                mainContainer.classList.remove('p-4', 'sm:p-6', 'lg:p-8');
                navLinks.innerHTML = `<a href="#" data-view="login-view" class="view-switcher text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">ƒêƒÉng nh·∫≠p</a><a href="#" data-view="register-view" class="view-switcher bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition text-sm">ƒêƒÉng k√Ω</a>`;
                showView('home-view');
            }
            setupViewSwitcherListeners();
        };

        const renderDashboard = () => {
            const canAdmin = hasAdminRights(currentUser);
            document.getElementById('dashboard-title').textContent = canAdmin ? 'B·∫£ng ƒëi·ªÅu khi·ªÉn Qu·∫£n tr·ªã' : 'B·∫£ng ƒëi·ªÅu khi·ªÉn';

            const tabsContainer = document.getElementById('dashboard-tabs');
            let tabsHTML = `<a href="#" class="dashboard-tab border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="tasks">Qu·∫£n l√Ω C√¥ng vi·ªác</a>`;
            if (canAdmin) {
                tabsHTML += `<a href="#" class="dashboard-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="users">Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</a>`;
                tabsHTML += `<a href="#" class="dashboard-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="departments">Qu·∫£n l√Ω Ph√≤ng ban</a>`;
            }
            tabsHTML += `<a href="#" class="dashboard-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="stats">Th·ªëng k√™</a>`;
            
            tabsContainer.innerHTML = tabsHTML;
            
            renderTabContent('tasks'); 

            tabsContainer.querySelectorAll('.dashboard-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    tabsContainer.querySelectorAll('.dashboard-tab').forEach(t => {
                        t.classList.remove('border-blue-500', 'text-blue-600');
                        t.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                    });
                    e.target.classList.add('border-blue-500', 'text-blue-600');
                    e.target.classList.remove('border-transparent', 'text-gray-500');
                    renderTabContent(e.target.dataset.tab);
                });
            });
        };

        const renderTabContent = (tabId) => {
            const contentContainer = document.getElementById('tab-content');
            const canAdmin = hasAdminRights(currentUser);

            if (tabId === 'tasks') {
                contentContainer.innerHTML = getTasksViewHTML(); 
                updateAllTaskStatuses();
                renderTasksTable();
                setupTaskViewListeners();
            } else if (tabId === 'users' && canAdmin) {
                contentContainer.innerHTML = getUsersViewHTML();
                renderUsersTable();
                setupUserViewListeners();
            } else if (tabId === 'departments' && canAdmin) {
                contentContainer.innerHTML = getDepartmentsViewHTML();
                renderDepartmentsTable();
                setupDepartmentViewListeners();
            } else if (tabId === 'stats') {
                contentContainer.innerHTML = canAdmin ? getAdminStatsViewHTML() : getMemberStatsViewHTML();
                if (canAdmin) renderAdminStats();
                else renderMemberStats();
            }
        };

        // -- HTML Generators for Tab Content --
        const getTasksViewHTML = () => {
            const canAdmin = hasAdminRights(currentUser);
            return `
            <div class="bg-white p-4 rounded-lg shadow-sm mb-4">
                <div class="grid grid-cols-1 md:grid-cols-2 ${canAdmin ? 'lg:grid-cols-5' : 'lg:grid-cols-4'} gap-4 items-center">
                    <input type="text" id="task-search" placeholder="T√¨m ki·∫øm c√¥ng vi·ªác, vƒÉn b·∫£n..." class="w-full p-2 border rounded-lg ${canAdmin ? 'lg:col-span-1' : ''}">
                    <select id="task-filter-status" class="w-full p-2 border rounded-lg"><option value="">T·∫•t c·∫£ Tr·∫°ng th√°i</option>${['Ch∆∞a b·∫Øt ƒë·∫ßu', 'ƒêang th·ª±c hi·ªán', 'Ho√†n th√†nh', 'ƒê√£ h·ªßy'].map(s => `<option value="${s}">${s}</option>`).join('')}</select>
                    <select id="task-sort" class="w-full p-2 border rounded-lg"><option value="default">S·∫Øp x·∫øp m·∫∑c ƒë·ªãnh</option><option value="orderNumber_asc">Theo STT</option><option value="documentNumber_asc">Theo S·ªë vƒÉn b·∫£n</option></select>
                    ${canAdmin ? `<select id="task-filter-category" class="w-full p-2 border rounded-lg"><option value="">T·∫•t c·∫£ Danh m·ª•c</option>${TASK_CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('')}</select>` : ''}
                    <button id="toggle-timeline-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg text-sm whitespace-nowrap">${showTimeline ? '·∫®n' : 'Hi·ªán'} Ti·∫øn tr√¨nh</button>
                </div>
            </div>
            <div class="flex justify-between items-center mb-4">
                 <button id="add-task-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">+ Th√™m C√¥ng vi·ªác</button>
                 ${canAdmin ? `<button id="export-excel-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300">üì• Xu·∫•t Excel</button>` : ''}
            </div>
            <div class="bg-white rounded-lg shadow-md overflow-x-auto"><table class="w-full min-w-max text-left"><thead class="bg-gray-50"></thead><tbody id="tasks-table-body"></tbody></table></div>
        `};

        const getUsersViewHTML = () => `<div class="bg-white p-4 rounded-lg shadow-sm mb-4"><input type="text" id="user-search" placeholder="T√¨m theo t√™n, email, ph√≤ng ban..." class="w-full md:w-1/3 p-2 border rounded-lg"></div><div class="flex justify-start items-center mb-4"><button id="add-user-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">+ Th√™m Ng∆∞·ªùi d√πng</button></div><div class="bg-white rounded-lg shadow-md overflow-x-auto"><table class="w-full min-w-max text-left"><thead class="bg-gray-50"></thead><tbody id="users-table-body"></tbody></table></div>`;
        const getDepartmentsViewHTML = () => `<div class="flex justify-start items-center mb-4"><button id="add-department-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">+ Th√™m Ph√≤ng ban</button></div><div class="bg-white rounded-lg shadow-md overflow-x-auto"><table class="w-full min-w-max text-left"><thead class="bg-gray-50"></thead><tbody id="departments-table-body"></tbody></table></div>`;
        
        const getAdminStatsViewHTML = () => `<div id="stats-view" class="space-y-8"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-lg font-semibold text-gray-600">T·ªïng s·ªë ng∆∞·ªùi d√πng</h3><p id="stats-total-users" class="text-4xl font-bold text-blue-600">0</p></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-lg font-semibold text-gray-600">T·ªïng s·ªë c√¥ng vi·ªác</h3><p id="stats-total-tasks" class="text-4xl font-bold text-green-600">0</p></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-lg font-semibold text-gray-600">T·ªïng s·ªë ph√≤ng ban</h3><p id="stats-total-departments" class="text-4xl font-bold text-purple-600">0</p></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="space-y-8"><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-xl font-bold text-gray-800 mb-4">C√¥ng vi·ªác theo Tr·∫°ng th√°i</h3><div id="stats-tasks-by-status" class="space-y-3"></div></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-xl font-bold text-gray-800 mb-4">C√¥ng vi·ªác theo M·ª©c ƒë·ªô ∆∞u ti√™n</h3><div id="stats-tasks-by-priority" class="space-y-3"></div></div></div><div class="space-y-8"><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-xl font-bold text-gray-800 mb-4">Nh√¢n s·ª± theo Ph√≤ng ban</h3><div id="stats-users-by-department" class="space-y-3"></div></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-xl font-bold text-gray-800 mb-4">Th√†nh vi√™n t√≠ch c·ª±c nh·∫•t</h3><div id="stats-top-users" class="space-y-4"></div></div></div></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-xl font-bold text-gray-800 mb-4">Danh s√°ch c√¥ng vi·ªác chi ti·∫øt</h3><div class="overflow-x-auto"><table class="w-full min-w-max text-left"><thead class="bg-gray-50"></thead><tbody id="stats-task-list-body"></tbody></table></div></div></div>`;
        const getMemberStatsViewHTML = () => `<div id="stats-view" class="space-y-8"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-lg font-semibold text-gray-600">T·ªïng c√¥ng vi·ªác c·ªßa b·∫°n</h3><p id="stats-member-total-tasks" class="text-4xl font-bold text-green-600">0</p></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-lg font-semibold text-gray-600">C√¥ng vi·ªác ƒë√£ ho√†n th√†nh</h3><p id="stats-member-completed-tasks" class="text-4xl font-bold text-indigo-600">0</p></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-xl font-bold text-gray-800 mb-4">C√¥ng vi·ªác theo Tr·∫°ng th√°i</h3><div id="stats-member-tasks-by-status" class="space-y-3"></div></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-xl font-bold text-gray-800 mb-4">C√¥ng vi·ªác theo M·ª©c ƒë·ªô ∆∞u ti√™n</h3><div id="stats-member-tasks-by-priority" class="space-y-3"></div></div></div><div class="bg-white p-6 rounded-lg shadow"><h3 class="text-xl font-bold text-gray-800 mb-4">Danh s√°ch c√¥ng vi·ªác chi ti·∫øt</h3><div class="overflow-x-auto"><table class="w-full min-w-max text-left"><thead class="bg-gray-50"></thead><tbody id="stats-task-list-body"></tbody></table></div></div></div>`;
        const generateTimelineHTML = (task) => { const start = task.startDate ? new Date(task.startDate) : null; const end = task.endDate ? new Date(task.endDate) : null; if (!start || !end || start > end) return '<div class="mt-2 text-xs text-gray-400">Kh√¥ng ƒë·ªß d·ªØ li·ªáu ng√†y ƒë·ªÉ hi·ªÉn th·ªã ti·∫øn tr√¨nh.</div>'; const totalDuration = (end - start); const elapsedDuration = (TODAY - start); let progressPercent = 0; if (totalDuration > 0) progressPercent = Math.min(100, Math.max(0, (elapsedDuration / totalDuration) * 100)); else if (TODAY >= start) progressPercent = 100; let color = 'bg-yellow-400'; const isOverdue = TODAY > end && task.status !== 'Ho√†n th√†nh'; if (task.status === 'Ho√†n th√†nh') color = 'bg-blue-500'; else if (isOverdue) color = 'bg-red-500'; return `<div class="mt-3"><div class="flex justify-between text-xs text-gray-500 mb-1"><span class="font-semibold text-green-600">${task.startDate}</span><span class="font-bold">${progressPercent.toFixed(0)}%</span><span class="font-semibold text-gray-600">${task.endDate}</span></div><div class="relative h-2 w-full bg-gray-200 rounded-full" title="Ti·∫øn tr√¨nh: ${progressPercent.toFixed(0)}%"><div class="h-full rounded-full ${color}" style="width: ${progressPercent}%;"></div></div></div>`; };

        // -- Table Renderers --
        const renderTasksTable = () => {
            const canAdmin = hasAdminRights(currentUser);
            const table = document.querySelector('#tasks-table-body').parentElement;
            const tableHead = table.querySelector('thead');
            const tableBody = table.querySelector('tbody');

            tableHead.innerHTML = `<tr><th class="p-4 font-semibold text-gray-700">STT</th><th class="p-4 font-semibold text-gray-700">C√¥ng vi·ªác & VƒÉn b·∫£n</th>${canAdmin ? '<th class="p-4 font-semibold text-gray-700">G√°n cho</th>' : ''}<th class="p-4 font-semibold text-gray-700">Tr·∫°ng th√°i</th><th class="p-4 font-semibold text-gray-700">Ng√†y</th><th class="p-4 font-semibold text-gray-700 text-center">H√†nh ƒë·ªông</th></tr>`;
            
            const searchTerm = document.getElementById('task-search').value.toLowerCase();
            const statusFilter = document.getElementById('task-filter-status').value;
            const sortOption = document.getElementById('task-sort').value;
            let filteredTasks = canAdmin ? [...tasks] : tasks.filter(t => t.assignedTo === currentUser.id || t.createdBy === currentUser.id);
            filteredTasks = filteredTasks.filter(t => (t.title.toLowerCase().includes(searchTerm) || (t.documentNumber && t.documentNumber.toLowerCase().includes(searchTerm)) || (t.documentSummary && t.documentSummary.toLowerCase().includes(searchTerm))) && (!statusFilter || t.status === statusFilter));

            if (sortOption === 'orderNumber_asc') filteredTasks.sort((a, b) => (parseInt(a.orderNumber) || Infinity) - (parseInt(b.orderNumber) || Infinity));
            else if (sortOption === 'documentNumber_asc') filteredTasks.sort((a, b) => (a.documentNumber || '').localeCompare(b.documentNumber || ''));

            tableBody.innerHTML = '';
            if (filteredTasks.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${canAdmin ? 6:5}" class="text-center p-8 text-gray-500">Kh√¥ng t√¨m th·∫•y c√¥ng vi·ªác n√†o.</td></tr>`;
                return;
            }

            filteredTasks.forEach(task => {
                const assignedUser = users.find(u => u.id === task.assignedTo);
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-200 hover:bg-gray-50';
                const timelineHTML = showTimeline ? generateTimelineHTML(task) : '';
                tr.innerHTML = `<td class="p-4 align-top font-semibold text-gray-700">${task.orderNumber || ''}</td><td class="p-4 align-top"><div class="font-bold text-gray-800">${task.title}</div>${task.documentNumber ? `<div class="mt-1"><span class="font-semibold text-sm">VB:</span> <span class="text-sm text-gray-600">${task.documentNumber}</span> <button class="view-doc-btn text-blue-500 text-xs hover:underline" data-id="${task.id}">(Xem)</button></div><div class="text-sm text-gray-500 mt-1 line-clamp-2">${task.documentSummary || ''}</div>` : ''}${timelineHTML}</td>${canAdmin ? `<td class="p-4 align-top"><div class="flex items-center gap-2">${generateAvatar(assignedUser?.name, 'w-8 h-8')}<span class="text-sm">${assignedUser?.name || 'N/A'}</span></div></td>` : ''}<td class="p-4 align-top"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(task.status)}">${task.status}</span></td><td class="p-4 text-sm text-gray-600 align-top"><div>Bƒê: ${task.startDate || 'N/A'}</div><div>HT: ${task.endDate || 'N/A'}</div></td><td class="p-4 text-center align-top"><button data-id="${task.id}" class="edit-task-btn p-2 text-blue-600 hover:bg-blue-100 rounded-full">S·ª≠a</button><button data-id="${task.id}" class="delete-task-btn p-2 text-red-600 hover:bg-red-100 rounded-full">X√≥a</button></td>`;
                tableBody.appendChild(tr);
            });
        };

        const renderUsersTable = () => {
             const table = document.querySelector('#users-table-body').parentElement;
             table.querySelector('thead').innerHTML = `<tr><th class="p-4 font-semibold text-gray-700">Ng∆∞·ªùi d√πng</th><th class="p-4 font-semibold text-gray-700">Ch·ª©c v·ª• & Ph√≤ng ban</th><th class="p-4 font-semibold text-gray-700">Vai tr√≤</th><th class="p-4 font-semibold text-gray-700 text-center">H√†nh ƒë·ªông</th></tr>`;
             const tbody = table.querySelector('tbody');
             const searchTerm = document.getElementById('user-search').value.toLowerCase();
             const filteredUsers = users.filter(u => { const department = departments.find(d => d.id === u.departmentId); return u.name.toLowerCase().includes(searchTerm) || u.email.toLowerCase().includes(searchTerm) || (department && department.name.toLowerCase().includes(searchTerm)) });
             tbody.innerHTML = '';
             filteredUsers.forEach(user => { 
                const department = departments.find(d => d.id === user.departmentId); 
                const tr = document.createElement('tr'); 
                tr.className = 'border-b border-gray-200 hover:bg-gray-50'; 
                tr.innerHTML = `<td class="p-4"><div class="flex items-center gap-3">${generateAvatar(user.name)}<div><div class="font-bold text-gray-800">${user.name}</div><div class="text-sm text-gray-500">${user.email}</div></div></div></td><td class="p-4 text-sm text-gray-600"><div>${user.position || 'N/A'}</div><div class="text-xs text-gray-500">${department?.name || 'Ch∆∞a ph√¢n lo·∫°i'}</div></td><td class="p-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getRoleClass(user.role)}">${user.role}</span></td><td class="p-4 text-center"><button data-id="${user.id}" class="edit-user-btn p-2 text-blue-600 hover:bg-blue-100 rounded-full">S·ª≠a</button>${user.id !== currentUser.id ? `<button data-id="${user.id}" class="delete-user-btn p-2 text-red-600 hover:bg-red-100 rounded-full">X√≥a</button>` : ''}</td>`; 
                tbody.appendChild(tr); 
            });
        };

        const renderDepartmentsTable = () => {
             const table = document.querySelector('#departments-table-body').parentElement;
             table.querySelector('thead').innerHTML = `<tr><th class="p-4 font-semibold text-gray-700">T√™n Ph√≤ng ban</th><th class="p-4 font-semibold text-gray-700">S·ªë l∆∞·ª£ng th√†nh vi√™n</th><th class="p-4 font-semibold text-gray-700 text-center">H√†nh ƒë·ªông</th></tr>`;
             const tbody = table.querySelector('tbody');
             tbody.innerHTML = '';
             departments.forEach(dept => { const memberCount = users.filter(u => u.departmentId === dept.id).length; const tr = document.createElement('tr'); tr.className = 'border-b border-gray-200 hover:bg-gray-50'; tr.innerHTML = `<td class="p-4"><div class="font-bold text-gray-800">${dept.name}</div><div class="text-sm text-gray-500">${dept.description || ''}</div></td><td class="p-4">${memberCount}</td><td class="p-4 text-center"><button data-id="${dept.id}" class="edit-department-btn p-2 text-blue-600 hover:bg-blue-100 rounded-full">S·ª≠a</button><button data-id="${dept.id}" class="delete-department-btn p-2 text-red-600 hover:bg-red-100 rounded-full">X√≥a</button></td>`; tbody.appendChild(tr); });
        };
        
        const renderAdminStats = () => {
            const generateBarHTML = (label, count, maxCount, colorClass) => { const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0; return `<div><div class="flex justify-between items-center mb-1"><span class="text-sm font-medium text-gray-700">${label}</span><span class="text-sm font-bold text-gray-800">${count}</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="${colorClass} h-2.5 rounded-full" style="width: ${percentage}%"></div></div></div>`; };
            document.getElementById('stats-total-users').textContent = users.length;
            document.getElementById('stats-total-tasks').textContent = tasks.length;
            document.getElementById('stats-total-departments').textContent = departments.length;
            const statusCounts = tasks.reduce((acc, task) => { acc[task.status] = (acc[task.status] || 0) + 1; return acc; }, {});
            const maxStatusCount = Math.max(...Object.values(statusCounts), 0);
            const statusContainer = document.getElementById('stats-tasks-by-status');
            statusContainer.innerHTML = Object.entries(statusCounts).map(([status, count]) => generateBarHTML(status, count, maxStatusCount, getStatusClass(status).replace('text-', 'bg-').replace('-100', '-500'))).join('') || '<p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';
            const priorityCounts = tasks.reduce((acc, task) => { acc[task.priority] = (acc[task.priority] || 0) + 1; return acc; }, {});
            const maxPriorityCount = Math.max(...Object.values(priorityCounts), 0);
            const priorityContainer = document.getElementById('stats-tasks-by-priority');
            priorityContainer.innerHTML = Object.entries(priorityCounts).map(([priority, count]) => generateBarHTML(priority, count, maxPriorityCount, getPriorityClass(priority).replace('text-', 'bg-').replace('-100', '-500'))).join('') || '<p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';
            const deptCounts = departments.reduce((acc, dept) => { acc[dept.name] = users.filter(u => u.departmentId === dept.id).length; return acc; }, {});
            const maxDeptCount = Math.max(...Object.values(deptCounts), 0);
            const deptContainer = document.getElementById('stats-users-by-department');
            deptContainer.innerHTML = Object.entries(deptCounts).map(([deptName, count]) => generateBarHTML(deptName, count, maxDeptCount, 'bg-purple-500')).join('') || '<p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';
            const userTaskCounts = tasks.reduce((acc, task) => { if (task.assignedTo) acc[task.assignedTo] = (acc[task.assignedTo] || 0) + 1; return acc; }, {});
            const topUsers = Object.entries(userTaskCounts).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([userId, count]) => ({ user: users.find(u => u.id === userId), count }));
            const topUsersContainer = document.getElementById('stats-top-users');
            topUsersContainer.innerHTML = topUsers.map(item => item.user ? `<div class="flex items-center justify-between"><div class="flex items-center gap-3">${generateAvatar(item.user.name, 'w-9 h-9')}<span class="text-sm font-medium text-gray-800">${item.user.name}</span></div><span class="text-sm font-bold text-gray-600">${item.count} c√¥ng vi·ªác</span></div>` : '').join('') || '<p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';
            renderStatsTaskList(true);
        };
        
        const renderMemberStats = () => {
             const generateBarHTML = (label, count, maxCount, colorClass) => { const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0; return `<div><div class="flex justify-between items-center mb-1"><span class="text-sm font-medium text-gray-700">${label}</span><span class="text-sm font-bold text-gray-800">${count}</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="${colorClass} h-2.5 rounded-full" style="width: ${percentage}%"></div></div></div>`; };
            const memberTasks = tasks.filter(t => t.assignedTo === currentUser.id);
            document.getElementById('stats-member-total-tasks').textContent = memberTasks.length;
            document.getElementById('stats-member-completed-tasks').textContent = memberTasks.filter(t => t.status === 'Ho√†n th√†nh').length;
            const statusCounts = memberTasks.reduce((acc, task) => { acc[task.status] = (acc[task.status] || 0) + 1; return acc; }, {});
            const maxStatusCount = Math.max(...Object.values(statusCounts), 0);
            const statusContainer = document.getElementById('stats-member-tasks-by-status');
            statusContainer.innerHTML = Object.entries(statusCounts).map(([status, count]) => generateBarHTML(status, count, maxStatusCount, getStatusClass(status).replace('text-', 'bg-').replace('-100', '-500'))).join('') || '<p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';
            const priorityCounts = memberTasks.reduce((acc, task) => { acc[task.priority] = (acc[task.priority] || 0) + 1; return acc; }, {});
            const maxPriorityCount = Math.max(...Object.values(priorityCounts), 0);
            const priorityContainer = document.getElementById('stats-member-tasks-by-priority');
            priorityContainer.innerHTML = Object.entries(priorityCounts).map(([priority, count]) => generateBarHTML(priority, count, maxPriorityCount, getPriorityClass(priority).replace('text-', 'bg-').replace('-100', '-500'))).join('') || '<p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';
            renderStatsTaskList(false);
        };

        const renderStatsTaskList = (isAdmin) => {
            const table = document.querySelector('#stats-task-list-body').parentElement;
            const tableHead = table.querySelector('thead');
            const tableBody = table.querySelector('tbody');
            tableHead.innerHTML = `<tr><th class="p-4 font-semibold text-gray-700">STT</th><th class="p-4 font-semibold text-gray-700">C√¥ng vi·ªác & VƒÉn b·∫£n</th>${isAdmin ? '<th class="p-4 font-semibold text-gray-700">G√°n cho</th>' : ''}<th class="p-4 font-semibold text-gray-700">Tr·∫°ng th√°i</th><th class="p-4 font-semibold text-gray-700 text-center">H√†nh ƒë·ªông</th></tr>`;
            const taskList = isAdmin ? tasks : tasks.filter(t => t.assignedTo === currentUser.id);
            tableBody.innerHTML = '';
            if (taskList.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${isAdmin ? 5:4}" class="text-center p-8 text-gray-500">Kh√¥ng c√≥ c√¥ng vi·ªác n√†o.</td></tr>`;
                return;
            }
            taskList.forEach(task => {
                const assignedUser = users.find(u => u.id === task.assignedTo);
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-200 hover:bg-gray-50';
                tr.innerHTML = `<td class="p-4 align-top font-semibold text-gray-700">${task.orderNumber || ''}</td><td class="p-4 align-top"><div class="font-bold text-gray-800">${task.title}</div>${task.documentNumber ? `<div class="mt-1"><span class="font-semibold text-sm">VB:</span> <span class="text-sm text-gray-600">${task.documentNumber}</span> <button class="view-doc-btn text-blue-500 text-xs hover:underline" data-id="${task.id}">(Xem)</button></div>` : ''}</td>${isAdmin ? `<td class="p-4 align-top"><div class="flex items-center gap-2">${generateAvatar(assignedUser?.name, 'w-8 h-8')}<span class="text-sm">${assignedUser?.name || 'N/A'}</span></div></td>` : ''}<td class="p-4 align-top"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(task.status)}">${task.status}</span></td><td class="p-4 text-center align-top"><button data-id="${task.id}" class="edit-task-btn p-2 text-blue-600 hover:bg-blue-100 rounded-full">S·ª≠a</button><button data-id="${task.id}" class="delete-task-btn p-2 text-red-600 hover:bg-red-100 rounded-full">X√≥a</button></td>`;
                tableBody.appendChild(tr);
            });
        };

        // --- CORE LOGIC ---
        const getAutoTaskStatus = (task) => { if (task.status === 'Ho√†n th√†nh' || task.status === 'ƒê√£ h·ªßy') return task.status; const start = task.startDate ? new Date(task.startDate) : null; if (start) start.setHours(0,0,0,0); const end = task.endDate ? new Date(task.endDate) : null; if (end) end.setHours(0,0,0,0); if (!start) return 'Ch∆∞a b·∫Øt ƒë·∫ßu'; if (TODAY < start) return 'Ch∆∞a b·∫Øt ƒë·∫ßu'; if (end && TODAY > end) return 'Ho√†n th√†nh'; return 'ƒêang th·ª±c hi·ªán'; };
        const updateAllTaskStatuses = () => { let hasChanges = false; tasks.forEach(task => { const oldStatus = task.status; const newStatus = getAutoTaskStatus(task); if (oldStatus !== newStatus) { task.status = newStatus; hasChanges = true; } }); if (hasChanges) saveData(); return hasChanges; };
        const handleLogin = (e) => { e.preventDefault(); const email = document.getElementById('login-email').value, password = document.getElementById('login-password').value, user = users.find(u => u.email === email && u.password === password); if (user) { currentUser = user; sessionStorage.setItem(SESSION_KEY, JSON.stringify(currentUser)); updateUI(); showNotification('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!'); } else { showNotification('Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c.', true); } };
        const handleLogout = () => { currentUser = null; sessionStorage.removeItem(SESSION_KEY); updateUI(); };
        const handleRegister = (e) => { e.preventDefault(); const name = document.getElementById('register-name').value, email = document.getElementById('register-email').value, password = document.getElementById('register-password').value; if (users.find(u => u.email === email)) { showNotification('Email ƒë√£ t·ªìn t·∫°i!', true); return; } const defaultDept = departments.find(d => d.name === 'Ch∆∞a ph√¢n lo·∫°i') || departments[0]; const newUser = { id: `user_${Date.now()}`, name, email, password, role: 'Nh√¢n vi√™n', createdAt: new Date().toISOString(), departmentId: defaultDept?.id || null, position: '', phone: '' }; users.push(newUser); saveData(); showNotification('ƒêƒÉng k√Ω th√†nh c√¥ng!'); showView('login-view'); };
        const openTaskModal = (task = null) => { const canAdmin = hasAdminRights(currentUser); const userOptions = users.map(u => `<option value="${u.id}" ${task?.assignedTo === u.id || (!task && u.id === currentUser.id) ? 'selected' : ''}>${u.name}</option>`).join(''); const hasDocInfo = task?.documentNumber || task?.documentSummary || task?.implementingDepartment || task?.officeProposal || task?.leaderInCharge; const modalHTML = `<div class="modal-container fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="modal-content bg-white rounded-lg shadow-2xl p-6 w-full max-w-2xl mx-4 overflow-y-auto max-h-screen"><h2 class="text-2xl font-bold mb-6 text-gray-800">${task ? 'Ch·ªânh s·ª≠a C√¥ng vi·ªác' : 'Th√™m C√¥ng vi·ªác m·ªõi'}</h2><form id="task-form-modal"><input type="hidden" name="id" value="${task?.id || ''}"><input type="hidden" name="assignedTo" value="${canAdmin ? (task?.assignedTo || '') : currentUser.id}"><div class="space-y-4"><div><label class="font-semibold">Ti√™u ƒë·ªÅ</label><input type="text" name="title" class="w-full p-2 border rounded-lg" value="${task?.title || ''}" required></div><div><label class="font-semibold">M√¥ t·∫£ c√¥ng vi·ªác</label><textarea name="description" rows="2" class="w-full p-2 border rounded-lg">${task?.description || ''}</textarea></div><div class="border border-gray-200 rounded-lg"><button type="button" id="toggle-doc-info" class="w-full flex justify-between items-center p-3 bg-gray-50 hover:bg-gray-100"><span class="font-semibold text-gray-700">Th√¥ng tin vƒÉn b·∫£n h√†nh ch√≠nh</span><svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div id="doc-info-content" class="p-4 space-y-4 ${hasDocInfo ? '' : 'hidden'}"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium">S·ªë th·ª© t·ª±</label><input type="number" name="orderNumber" class="w-full p-2 border rounded-lg" value="${task?.orderNumber || ''}"></div><div><label class="block text-sm font-medium">S·ªë vƒÉn b·∫£n</label><input type="text" name="documentNumber" class="w-full p-2 border rounded-lg" value="${task?.documentNumber || ''}"></div></div><div><label class="block text-sm font-medium">Tr√≠ch y·∫øu vƒÉn b·∫£n</label><textarea name="documentSummary" rows="2" class="w-full p-2 border rounded-lg">${task?.documentSummary || ''}</textarea></div><div><label class="block text-sm font-medium">S·ªü ng√†nh th·ª±c hi·ªán</label><input type="text" name="implementingDepartment" class="w-full p-2 border rounded-lg" value="${task?.implementingDepartment || ''}"></div><div><label class="block text-sm font-medium">ƒê·ªÅ xu·∫•t c·ªßa VP UBND t·ªânh</label><textarea name="officeProposal" rows="2" class="w-full p-2 border rounded-lg">${task?.officeProposal || ''}</textarea></div><div><label class="block text-sm font-medium">L√£nh ƒë·∫°o ph·ª• tr√°ch</label><input type="text" name="leaderInCharge" class="w-full p-2 border rounded-lg" value="${task?.leaderInCharge || ''}"></div></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${canAdmin ? `<div><label class="font-semibold">G√°n cho</label><select name="assignedTo" class="w-full p-2 border rounded-lg">${userOptions}</select></div>` : ''}<div><label class="font-semibold">Danh m·ª•c</label><select name="category" class="w-full p-2 border rounded-lg">${TASK_CATEGORIES.map(c => `<option value="${c}" ${task?.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="font-semibold">Tr·∫°ng th√°i</label><select name="status" class="w-full p-2 border rounded-lg">${['Ch∆∞a b·∫Øt ƒë·∫ßu', 'ƒêang th·ª±c hi·ªán', 'Ho√†n th√†nh', 'ƒê√£ h·ªßy'].map(s => `<option value="${s}" ${task?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div><div><label class="font-semibold">M·ª©c ƒë·ªô ∆∞u ti√™n</label><select name="priority" class="w-full p-2 border rounded-lg">${['Th·∫•p', 'Trung b√¨nh', 'Cao', 'Kh·∫©n c·∫•p'].map(p => `<option value="${p}" ${task?.priority === p ? 'selected' : ''}>${p}</option>`).join('')}</select></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="font-semibold">Ng√†y b·∫Øt ƒë·∫ßu</label><input type="date" name="startDate" class="w-full p-2 border rounded-lg" value="${task?.startDate || ''}"></div><div><label class="font-semibold">Ng√†y ho√†n th√†nh</label><input type="date" name="endDate" class="w-full p-2 border rounded-lg" value="${task?.endDate || ''}"></div></div></div><div class="flex justify-end gap-4 mt-6"><button type="button" class="modal-close bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">H·ªßy</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">L∆∞u</button></div></form></div></div>`; showModal(modalHTML); const toggleBtn = document.getElementById('toggle-doc-info'); const contentDiv = document.getElementById('doc-info-content'); toggleBtn.addEventListener('click', () => { contentDiv.classList.toggle('hidden'); toggleBtn.querySelector('svg').classList.toggle('rotate-180'); }); attachAutoStatusListenerToForm('task-form-modal'); };
        const handleTaskSubmit = (e) => { e.preventDefault(); const formData = new FormData(e.target); const id = formData.get('id'); const taskData = { title: formData.get('title'), description: formData.get('description'), assignedTo: formData.get('assignedTo'), category: formData.get('category'), status: formData.get('status'), priority: formData.get('priority'), startDate: formData.get('startDate'), endDate: formData.get('endDate'), orderNumber: formData.get('orderNumber'), documentNumber: formData.get('documentNumber'), documentSummary: formData.get('documentSummary'), implementingDepartment: formData.get('implementingDepartment'), officeProposal: formData.get('officeProposal'), leaderInCharge: formData.get('leaderInCharge'), }; if (id) { const existingTask = tasks.find(t => t.id === id); Object.assign(existingTask, taskData); showNotification('C·∫≠p nh·∫≠t c√¥ng vi·ªác th√†nh c√¥ng!'); } else { taskData.id = `task_${Date.now()}`; taskData.createdBy = currentUser.id; tasks.push(taskData); showNotification('Th√™m c√¥ng vi·ªác m·ªõi th√†nh c√¥ng!'); } saveData(); renderTasksTable(); closeModal(); };
        const deleteTask = (taskId) => { if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¥ng vi·ªác n√†y?")) { tasks = tasks.filter(t => t.id !== taskId); saveData(); renderTasksTable(); showNotification('ƒê√£ x√≥a c√¥ng vi·ªác.'); } };
        const showDocumentDetailModal = (taskId) => { const task = tasks.find(t => t.id === taskId); if (!task) return; const modalHTML = `<div class="modal-container fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="modal-content bg-white rounded-lg shadow-2xl p-6 w-full max-w-xl mx-4"><h3 class="text-xl font-bold mb-4 text-gray-800">Chi ti·∫øt VƒÉn b·∫£n: ${task.documentNumber || ''}</h3><div class="space-y-3 text-sm"><div><strong class="font-semibold text-gray-600 w-48 inline-block">S·ªë th·ª© t·ª±:</strong> ${task.orderNumber || 'N/A'}</div><div><strong class="font-semibold text-gray-600 w-48 inline-block">S·ªë vƒÉn b·∫£n:</strong> ${task.documentNumber || 'N/A'}</div><div class="pt-2"><strong class="font-semibold text-gray-600 block mb-1">Tr√≠ch y·∫øu:</strong><p class="text-gray-700 bg-gray-50 p-2 rounded">${task.documentSummary || 'N/A'}</p></div><div class="pt-2"><strong class="font-semibold text-gray-600 block mb-1">S·ªü ng√†nh th·ª±c hi·ªán:</strong><p class="text-gray-700">${task.implementingDepartment || 'N/A'}</p></div><div class="pt-2"><strong class="font-semibold text-gray-600 block mb-1">ƒê·ªÅ xu·∫•t VP UBND:</strong><p class="text-gray-700 bg-gray-50 p-2 rounded">${task.officeProposal || 'N/A'}</p></div><div><strong class="font-semibold text-gray-600 w-48 inline-block">L√£nh ƒë·∫°o ph·ª• tr√°ch:</strong> ${task.leaderInCharge || 'N/A'}</div></div><div class="flex justify-end mt-6"><button type="button" class="modal-close bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">ƒê√≥ng</button></div></div></div>`; showModal(modalHTML); };
        const openUserModal = (user = null) => {
            const roleOptions = USER_ROLES.map(r => `<option value="${r}" ${user?.role === r ? 'selected' : ''}>${r}</option>`).join('');
            const departmentOptions = departments.map(d => `<option value="${d.id}" ${user?.departmentId === d.id ? 'selected' : ''}>${d.name}</option>`).join(''); 
            const modalHTML = `<div class="modal-container fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="modal-content bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg mx-4"><h2 class="text-2xl font-bold mb-6 text-gray-800">${user ? 'Ch·ªânh s·ª≠a ng∆∞·ªùi d√πng' : 'Th√™m ng∆∞·ªùi d√πng m·ªõi'}</h2><form id="user-form-modal"><input type="hidden" name="id" value="${user?.id || ''}"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label class="block font-semibold">H·ªç t√™n</label><input type="text" name="name" class="w-full p-2 border rounded-lg" value="${user?.name || ''}" required></div><div><label class="block font-semibold">Email</label><input type="email" name="email" class="w-full p-2 border rounded-lg" value="${user?.email || ''}" required></div></div><div class="mb-4"><label class="block font-semibold">M·∫≠t kh·∫©u</label><input type="password" name="password" class="w-full p-2 border rounded-lg" placeholder="${user ? 'ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi' : ''}" ${user ? '' : 'required'}></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label class="block font-semibold">Ph√≤ng ban</label><select name="departmentId" class="w-full p-2 border rounded-lg">${departmentOptions}</select></div><div><label class="block font-semibold">Ch·ª©c v·ª•</label><input type="text" name="position" class="w-full p-2 border rounded-lg" value="${user?.position || ''}"></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"><div><label class="block font-semibold">Vai tr√≤</label><select name="role" class="w-full p-2 border rounded-lg" ${user?.id === currentUser.id ? 'disabled' : ''}>${roleOptions}</select></div></div><div class="flex justify-end gap-4"><button type="button" class="modal-close bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">H·ªßy</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">L∆∞u</button></div></form></div></div>`; showModal(modalHTML); document.getElementById('user-form-modal').addEventListener('submit', handleUserSubmit); };
        const handleUserSubmit = (e) => { e.preventDefault(); const formData = new FormData(e.target); const id = formData.get('id'); if (users.find(u => u.email === formData.get('email') && u.id !== id)) { showNotification('Email ƒë√£ t·ªìn t·∫°i!', true); return; } const userData = { name: formData.get('name'), email: formData.get('email'), departmentId: formData.get('departmentId'), position: formData.get('position'), role: formData.get('role'), }; if (formData.get('password')) { userData.password = formData.get('password'); } if (id) { const existingUser = users.find(u => u.id === id); Object.assign(existingUser, userData); showNotification('C·∫≠p nh·∫≠t ng∆∞·ªùi d√πng th√†nh c√¥ng!'); } else { userData.id = `user_${Date.now()}`; userData.createdAt = new Date().toISOString(); users.push(userData); showNotification('Th√™m ng∆∞·ªùi d√πng m·ªõi th√†nh c√¥ng!'); } saveData(); renderUsersTable(); closeModal(); };
        const deleteUser = (userId) => { if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y? Thao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c.")) { users = users.filter(u => u.id !== userId); saveData(); renderUsersTable(); renderTasksTable(); showNotification('ƒê√£ x√≥a ng∆∞·ªùi d√πng.'); } };
        const openDepartmentModal = (dept = null) => { const modalHTML = `<div class="modal-container fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="modal-content bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg mx-4"><h2 class="text-2xl font-bold mb-6 text-gray-800">${dept ? 'Ch·ªânh s·ª≠a Ph√≤ng ban' : 'Th√™m Ph√≤ng ban m·ªõi'}</h2><form id="department-form-modal"><input type="hidden" name="id" value="${dept?.id || ''}"><div class="mb-4"><label class="block font-semibold">T√™n ph√≤ng ban</label><input type="text" name="name" class="w-full p-2 border rounded-lg" value="${dept?.name || ''}" required></div><div class="mb-4"><label class="block font-semibold">M√¥ t·∫£</label><textarea name="description" class="w-full p-2 border rounded-lg">${dept?.description || ''}</textarea></div><div class="flex justify-end gap-4"><button type="button" class="modal-close bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">H·ªßy</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">L∆∞u</button></div></form></div></div>`; showModal(modalHTML); document.getElementById('department-form-modal').addEventListener('submit', handleDepartmentSubmit); };
        const handleDepartmentSubmit = (e) => { e.preventDefault(); const formData = new FormData(e.target); const id = formData.get('id'); const deptData = { name: formData.get('name'), description: formData.get('description') }; if (id) { const existingDept = departments.find(d => d.id === id); Object.assign(existingDept, deptData); showNotification('C·∫≠p nh·∫≠t ph√≤ng ban th√†nh c√¥ng!'); } else { deptData.id = `dept_${Date.now()}`; departments.push(deptData); showNotification('Th√™m ph√≤ng ban m·ªõi th√†nh c√¥ng!'); } saveData(); renderDepartmentsTable(); closeModal(); };
        const deleteDepartment = (deptId) => { const memberCount = users.filter(u => u.departmentId === deptId).length; if (memberCount > 0) { showNotification('Kh√¥ng th·ªÉ x√≥a ph√≤ng ban c√≥ th√†nh vi√™n.', true); return; } if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ph√≤ng ban n√†y?')) { departments = departments.filter(d => d.id !== deptId); saveData(); renderDepartmentsTable(); showNotification('ƒê√£ x√≥a ph√≤ng ban.'); } };
        const exportToExcel = () => { const data = tasks.map(task => { const assigned = users.find(u => u.id === task.assignedTo); const creator = users.find(u => u.id === task.createdBy); return { 'STT': task.orderNumber, 'S·ªë vƒÉn b·∫£n': task.documentNumber, 'Tr√≠ch y·∫øu': task.documentSummary, 'S·ªü ng√†nh th·ª±c hi·ªán': task.implementingDepartment, 'ƒê·ªÅ xu·∫•t VP UBND': task.officeProposal, 'L√£nh ƒë·∫°o ph·ª• tr√°ch': task.leaderInCharge, 'Ti√™u ƒë·ªÅ c√¥ng vi·ªác': task.title, 'Tr·∫°ng th√°i': task.status, 'G√°n cho': assigned ? assigned.name : 'N/A', 'Ng√†y b·∫Øt ƒë·∫ßu': task.startDate || '', 'Ng√†y ho√†n th√†nh': task.endDate || '' } }); if (data.length === 0) { showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu c√¥ng vi·ªác ƒë·ªÉ xu·∫•t.', true); return; } const worksheet = XLSX.utils.json_to_sheet(data); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, 'CongViec'); XLSX.writeFile(workbook, `TaskFlow_CongViec_${new Date().toISOString().slice(0, 10)}.xlsx`); };

        // --- EVENT LISTENER SETUP ---
        function setupGlobalListeners() {
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.body.addEventListener('click', e => {
                const target = e.target;
                if(target.closest('.edit-task-btn')) openTaskModal(tasks.find(t => t.id === target.closest('.edit-task-btn').dataset.id));
                if(target.closest('.delete-task-btn')) deleteTask(target.closest('.delete-task-btn').dataset.id);
                if(target.closest('.view-doc-btn')) showDocumentDetailModal(target.closest('.view-doc-btn').dataset.id);
                if(target.closest('.edit-user-btn')) openUserModal(users.find(u => u.id === target.closest('.edit-user-btn').dataset.id));
                if(target.closest('.delete-user-btn')) deleteUser(target.closest('.delete-user-btn').dataset.id);
                if(target.closest('.edit-department-btn')) openDepartmentModal(departments.find(d => d.id === target.closest('.edit-department-btn').dataset.id));
                if(target.closest('.delete-department-btn')) deleteDepartment(target.closest('.delete-department-btn').dataset.id);
            });
        }
        
        function setupViewSwitcherListeners() { document.querySelectorAll('.view-switcher').forEach(button => { const listener = (e) => { e.preventDefault(); showView(e.target.closest('.view-switcher').dataset.view); }; button.removeEventListener('click', listener); button.addEventListener('click', listener); }); }
        function setupTaskViewListeners() {
            const addTaskBtn = document.getElementById('add-task-btn'); if(addTaskBtn) addTaskBtn.addEventListener('click', () => openTaskModal());
            const exportBtn = document.getElementById('export-excel-btn'); if(exportBtn) exportBtn.addEventListener('click', exportToExcel);
            const toggleTimelineBtn = document.getElementById('toggle-timeline-btn'); if(toggleTimelineBtn) toggleTimelineBtn.addEventListener('click', () => { showTimeline = !showTimeline; renderTasksTable(); toggleTimelineBtn.textContent = `${showTimeline ? '·∫®n' : 'Hi·ªán'} Ti·∫øn tr√¨nh`; toggleTimelineBtn.classList.toggle('bg-blue-100', showTimeline); toggleTimelineBtn.classList.toggle('text-blue-700', showTimeline); });
            document.getElementById('task-search').addEventListener('input', renderTasksTable);
            document.getElementById('task-filter-status').addEventListener('change', renderTasksTable);
            document.getElementById('task-sort').addEventListener('change', renderTasksTable);
            const categoryFilter = document.getElementById('task-filter-category'); if (categoryFilter) categoryFilter.addEventListener('change', renderTasksTable);
        }
        function attachAutoStatusListenerToForm(formId) {
            const form = document.getElementById(formId);
            const startDateInput = form.querySelector('[name="startDate"]');
            const endDateInput = form.querySelector('[name="endDate"]');
            const statusSelect = form.querySelector('[name="status"]');
            const updateStatus = () => { const tempTask = { startDate: startDateInput.value, endDate: endDateInput.value, status: statusSelect.value }; const newStatus = getAutoTaskStatus(tempTask); if (statusSelect.value !== newStatus && statusSelect.value !== 'Ho√†n th√†nh' && statusSelect.value !== 'ƒê√£ h·ªßy') { statusSelect.value = newStatus; } };
            startDateInput.addEventListener('change', updateStatus);
            endDateInput.addEventListener('change', updateStatus);
            form.addEventListener('submit', handleTaskSubmit);
        };
        function setupUserViewListeners() { document.getElementById('add-user-btn').addEventListener('click', () => openUserModal()); document.getElementById('user-search').addEventListener('input', renderUsersTable); }
        function setupDepartmentViewListeners() { document.getElementById('add-department-btn').addEventListener('click', () => openDepartmentModal()); }

        // --- APP INITIALIZATION ---
        const init = () => {
            loadData(); createDefaultAdmin(); setupGlobalListeners(); updateUI();
            setInterval(() => { console.log('Running periodic task status update...'); const changed = updateAllTaskStatuses(); if (changed && document.getElementById('dashboard-view').style.display !== 'none') { const currentTab = document.querySelector('.dashboard-tab.border-blue-500'); if (currentTab && currentTab.dataset.tab === 'tasks') { renderTasksTable(); } } }, 1000 * 60 * 60);
        };

        init();
    });
    </script>
</body>
</html>
