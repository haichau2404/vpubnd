<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VÄ‚N PHÃ’NG UBND Tá»ˆNH LÃ‚M Äá»’NG - Há»‡ thá»‘ng Quáº£n lÃ½ CÃ´ng viá»‡c</title>
    <!-- TÃ­ch há»£p Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- TÃ­ch há»£p thÆ° viá»‡n SheetJS (xlsx) Ä‘á»ƒ xuáº¥t file Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* TÃ¹y chá»‰nh thanh cuá»™n */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        /* áº¨n cÃ¡c view vÃ  modal máº·c Ä‘á»‹nh */
        .view, .modal-container { display: none; }
        /* Animation cho modal */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-container.flex { animation: fadeIn 0.3s ease-out; }
        .modal-content { animation: slideIn 0.3s ease-out; }
        #home-view-background {
            background-image: url('https://image.baophapluat.vn/w800/Uploaded/2025/vngtsu/2025_03_11/tinhlamdong-9972-2431.jpg');
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <nav id="navbar" class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <a href="#" class="text-sm sm:text-lg md:text-xl font-bold text-blue-700 flex items-center gap-2 uppercase">
                        VÄ‚N PHÃ’NG UBND Tá»ˆNH LÃ‚M Äá»’NG
                    </a>
                </div>
                <div id="nav-links" class="flex items-center space-x-2 sm:space-x-4"></div>
            </div>
        </div>
    </nav>

    <main id="app" class="container mx-auto">
        <div id="home-view" class="view">
            <div id="home-view-background" class="relative h-[calc(100vh-4rem)] min-h-[600px] flex items-center">
                <div class="absolute inset-0 bg-gradient-to-r from-black/70 to-black/40"></div>
                <div class="relative z-10 w-full px-4 sm:px-6 lg:px-8">
                    <div class="max-w-3xl text-left">
                        <h2 class="text-lg font-semibold text-blue-300 uppercase tracking-widest">Há»‡ thá»‘ng thÃ´ng tin</h2>
                        <h1 class="text-4xl md:text-6xl font-extrabold text-white my-3 leading-tight">Äiá»u hÃ nh vÃ  Quáº£n lÃ½ CÃ´ng viá»‡c</h1>
                        <p class="text-base md:text-lg text-gray-200 mb-8 max-w-2xl">
                            Ná»n táº£ng sá»‘ giÃºp tá»‘i Æ°u hÃ³a quy trÃ¬nh xá»­ lÃ½ vÄƒn báº£n, theo dÃµi vÃ  Ä‘Ã´n Ä‘á»‘c tiáº¿n Ä‘á»™ cÃ´ng viá»‡c má»™t cÃ¡ch hiá»‡u quáº£, minh báº¡ch.
                        </p>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button data-view="login-view" class="view-switcher w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-blue-700 transition duration-300 text-lg">ÄÄƒng nháº­p</button>
                            <button data-view="register-view" class="view-switcher w-full sm:w-auto bg-white bg-opacity-90 text-blue-700 font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-gray-200 transition duration-300 text-lg">ÄÄƒng kÃ½</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="login-view" class="view max-w-md mx-auto p-4 sm:p-6 lg:p-8">
             <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">ÄÄƒng nháº­p</h2>
                <form id="login-form">
                    <div class="mb-4"><label for="login-email" class="block text-gray-700 font-semibold mb-2">Email</label><input type="email" id="login-email" class="w-full p-3 border border-gray-300 rounded-lg" required value="admin@taskflow.com"></div>
                    <div class="mb-6"><label for="login-password" class="block text-gray-700 font-semibold mb-2">Máº­t kháº©u</label><input type="password" id="login-password" class="w-full p-3 border border-gray-300 rounded-lg" required value="admin"></div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">ÄÄƒng nháº­p</button>
                    <p class="text-center mt-4">ChÆ°a cÃ³ tÃ i khoáº£n? <a href="#" data-view="register-view" class="view-switcher text-blue-600 hover:underline">ÄÄƒng kÃ½ ngay</a></p>
                </form>
            </div>
        </div>
        
        <div id="register-view" class="view max-w-md mx-auto p-4 sm:p-6 lg:p-8">
            <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Táº¡o tÃ i khoáº£n</h2>
                <form id="register-form">
                     <div class="mb-4"><label for="register-name" class="block text-gray-700 font-semibold mb-2">Há» vÃ  tÃªn</label><input type="text" id="register-name" class="w-full p-3 border border-gray-300 rounded-lg" required></div>
                     <div class="mb-4"><label for="register-email" class="block text-gray-700 font-semibold mb-2">Email</label><input type="email" id="register-email" class="w-full p-3 border border-gray-300 rounded-lg" required></div>
                     <div class="mb-6"><label for="register-password" class="block text-gray-700 font-semibold mb-2">Máº­t kháº©u</label><input type="password" id="register-password" class="w-full p-3 border border-gray-300 rounded-lg" required></div>
                     <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">ÄÄƒng kÃ½</button>
                     <p class="text-center mt-4">ÄÃ£ cÃ³ tÃ i khoáº£n? <a href="#" data-view="login-view" class="view-switcher text-blue-600 hover:underline">ÄÄƒng nháº­p</a></p>
                </form>
            </div>
        </div>

        <div id="dashboard-view" class="view p-4 sm:p-6 lg:p-8">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-4">
                 <h2 id="dashboard-title" class="text-2xl sm:text-3xl font-bold text-gray-800">Báº£ng Ä‘iá»u khiá»ƒn</h2>
                 <div id="dashboard-actions"></div>
            </div>
            <div class="mb-4 border-b border-gray-200 overflow-x-auto"><nav id="dashboard-tabs" class="-mb-px flex space-x-6 sm:space-x-8" aria-label="Tabs"></nav></div>
            <div id="tab-content"></div>
        </div>
    </main>

    <div id="modal-placeholder"></div>

    <script>
    // --- FIREBASE SETUP ---
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    document.addEventListener('DOMContentLoaded', () => {

        // --- GLOBAL STATE & CONSTANTS ---
        const navLinks = document.getElementById('nav-links');
        const modalPlaceholder = document.getElementById('modal-placeholder');
        const USER_ROLES = ['admin', 'LÃ£nh Ä‘áº¡o VÄƒn phÃ²ng UBND tá»‰nh', 'TrÆ°á»Ÿng phÃ²ng', 'PhÃ³ TrÆ°á»Ÿng phÃ²ng', 'ChuyÃªn viÃªn', 'NhÃ¢n viÃªn'];
        const TASK_CATEGORIES = ['PhÃ¡t triá»ƒn', 'Thiáº¿t káº¿', 'Marketing', 'Há»p', 'NghiÃªn cá»©u', 'KhÃ¡c'];
        const TODAY = new Date(); TODAY.setHours(0, 0, 0, 0);

        let users = [];
        let tasks = [];
        let departments = [];
        let currentUserData = null;
        let showTimeline = false;
        
        let unsubscribes = [];

        // --- UI UTILITIES ---
        const getRoleClass = (r) => ({'admin':'bg-purple-200 text-purple-800','LÃ£nh Ä‘áº¡o VÄƒn phÃ²ng UBND tá»‰nh':'bg-rose-200 text-rose-800','TrÆ°á»Ÿng phÃ²ng':'bg-red-200 text-red-800','PhÃ³ TrÆ°á»Ÿng phÃ²ng':'bg-orange-200 text-orange-800','ChuyÃªn viÃªn':'bg-blue-200 text-blue-800','NhÃ¢n viÃªn':'bg-gray-200 text-gray-800'}[r]||'bg-gray-200 text-gray-800');
        const getPriorityClass = (p) => ({'Kháº©n cáº¥p':'bg-red-100 text-red-800','Cao':'bg-orange-100 text-orange-800','Trung bÃ¬nh':'bg-blue-100 text-blue-800','Tháº¥p':'bg-gray-100 text-gray-800'}[p] || 'bg-gray-100 text-gray-800');
        const getStatusClass = (s) => ({'HoÃ n thÃ nh':'bg-green-100 text-green-800','Äang thá»±c hiá»‡n':'bg-indigo-100 text-indigo-800','ÄÃ£ há»§y':'bg-pink-100 text-pink-800','ChÆ°a báº¯t Ä‘áº§u':'bg-gray-100 text-gray-800'}[s] || 'bg-gray-100 text-gray-800');
        const generateAvatar = (name = '?', size = 'w-10 h-10') => { const initials = name.split(' ').map(n=>n[0]).join('').toUpperCase(); const colors = ['bg-blue-500', 'bg-green-500', 'bg-indigo-500', 'bg-purple-500', 'bg-pink-500', 'bg-red-500']; const color = colors[initials.charCodeAt(0) % colors.length]; return `<div class="${size} ${color} rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">${initials}</div>`; };
        const showView = (viewId) => { document.querySelectorAll('.view').forEach(v => v.style.display = 'none'); document.getElementById(viewId).style.display = 'block'; };
        const showModal = (content) => { modalPlaceholder.innerHTML = content; modalPlaceholder.querySelector('.modal-container').style.display = 'flex'; modalPlaceholder.querySelectorAll('.modal-close').forEach(el => el.addEventListener('click', closeModal)); modalPlaceholder.querySelector('.modal-container').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); }); };
        const closeModal = () => { if(modalPlaceholder.querySelector('.modal-container')) modalPlaceholder.querySelector('.modal-container').style.display = 'none'; };
        const showNotification = (message, isError = false) => { const color = isError ? 'bg-red-500' : 'bg-green-500'; const notif = document.createElement('div'); notif.className = `fixed bottom-5 right-5 ${color} text-white py-2 px-4 rounded-lg shadow-lg z-50`; notif.textContent = message; document.body.appendChild(notif); setTimeout(() => notif.remove(), 3000); };
        const hasAdminRights = (user) => user && (user.role === 'admin' || user.role === 'LÃ£nh Ä‘áº¡o VÄƒn phÃ²ng UBND tá»‰nh');

        // --- REAL-TIME DATA LISTENERS ---
        const setupDataListeners = () => {
            if (unsubscribes.length > 0) clearDataAndListeners();
            unsubscribes.push(db.collection('users').onSnapshot(snapshot => { users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (auth.currentUser) { currentUserData = users.find(u => u.id === auth.currentUser.uid); } refreshUI(); }, error => console.error("Error fetching users:", error)));
            unsubscribes.push(db.collection('tasks').onSnapshot(snapshot => { tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); refreshUI(); }, error => console.error("Error fetching tasks:", error)));
            unsubscribes.push(db.collection('departments').onSnapshot(snapshot => { departments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); refreshUI(); }, error => console.error("Error fetching departments:", error)));
        };
        
        const clearDataAndListeners = () => { unsubscribes.forEach(unsub => unsub()); unsubscribes = []; users = []; tasks = []; departments = []; currentUserData = null; };
        
        const refreshUI = () => { if (!auth.currentUser) return; const activeTabEl = document.querySelector('.dashboard-tab.border-blue-500'); if (activeTabEl) { renderTabContent(activeTabEl.dataset.tab); } };
        
        // --- AUTHENTICATION ---
        auth.onAuthStateChanged(user => {
            if (user) {
                if(unsubscribes.length === 0) setupDataListeners();
                updateLoggedInUI(user);
            } else {
                clearDataAndListeners();
                updateLoggedOutUI();
            }
        });

        const updateLoggedInUI = (user) => {
            if (!users.length) { setTimeout(() => updateLoggedInUI(user), 150); return; }
            currentUserData = users.find(u => u.id === user.uid);
            if (!currentUserData) { console.log("Waiting for user data..."); setTimeout(() => updateLoggedInUI(user), 250); return; }

            document.querySelector('main').classList.add('p-4', 'sm:p-6', 'lg:p-8');
            navLinks.innerHTML = `<span class="font-semibold text-gray-700 hidden sm:block">ChÃ o, ${currentUserData.name}!</span><div id="user-avatar" class="cursor-pointer">${generateAvatar(currentUserData.name, 'w-9 h-9')}</div><button id="logout-btn" class="bg-red-100 text-red-700 font-bold py-2 px-3 text-sm rounded-lg hover:bg-red-200 transition">ÄÄƒng xuáº¥t</button>`;
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            renderDashboard();
            showView('dashboard-view');
        };

        const updateLoggedOutUI = () => {
            document.querySelector('main').classList.remove('p-4', 'sm:p-6', 'lg:p-8');
            navLinks.innerHTML = `<a href="#" data-view="login-view" class="view-switcher text-gray-600 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">ÄÄƒng nháº­p</a><a href="#" data-view="register-view" class="view-switcher bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition text-sm">ÄÄƒng kÃ½</a>`;
            showView('home-view');
            setupViewSwitcherListeners();
        };

        const handleLogin = (e) => { e.preventDefault(); const email = document.getElementById('login-email').value, password = document.getElementById('login-password').value; auth.signInWithEmailAndPassword(email, password).then(() => showNotification('ÄÄƒng nháº­p thÃ nh cÃ´ng!')).catch(err => showNotification(`Lá»—i: ${err.message}`, true)); };
        const handleLogout = () => auth.signOut();
        const handleRegister = (e) => {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const defaultDept = departments.find(d => d.name === 'ChÆ°a phÃ¢n loáº¡i') || departments[0];
                    db.collection('users').doc(userCredential.user.uid).set({ name: name, email: email, role: 'NhÃ¢n viÃªn', createdAt: new Date().toISOString(), departmentId: defaultDept?.id || null, position: '', phone: '' }).then(() => { showNotification('ÄÄƒng kÃ½ thÃ nh cÃ´ng!'); showView('login-view'); });
                })
                .catch(err => showNotification(`Lá»—i Ä‘Äƒng kÃ½: ${err.message}`, true));
        };
        
        const renderDashboard = () => {
            const canAdmin = hasAdminRights(currentUserData);
            document.getElementById('dashboard-title').textContent = canAdmin ? 'Báº£ng Ä‘iá»u khiá»ƒn Quáº£n trá»‹' : 'Báº£ng Ä‘iá»u khiá»ƒn';
            const tabsContainer = document.getElementById('dashboard-tabs');
            let tabsHTML = `<a href="#" class="dashboard-tab border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="tasks">Quáº£n lÃ½ CÃ´ng viá»‡c</a>`;
            if (canAdmin) {
                tabsHTML += `<a href="#" class="dashboard-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="users">Quáº£n lÃ½ NgÆ°á»i dÃ¹ng</a>`;
                tabsHTML += `<a href="#" class="dashboard-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="departments">Quáº£n lÃ½ PhÃ²ng ban</a>`;
            }
            tabsHTML += `<a href="#" class="dashboard-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="stats">Thá»‘ng kÃª</a>`;
            tabsContainer.innerHTML = tabsHTML;
            renderTabContent('tasks'); 
            tabsContainer.querySelectorAll('.dashboard-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    tabsContainer.querySelectorAll('.dashboard-tab').forEach(t => { t.classList.replace('border-blue-500','border-transparent'); t.classList.replace('text-blue-600','text-gray-500');});
                    e.target.classList.replace('border-transparent','border-blue-500'); e.target.classList.replace('text-gray-500','text-blue-600');
                    renderTabContent(e.target.dataset.tab);
                });
            });
        };

        const renderTabContent = (tabId) => {
            const contentContainer = document.getElementById('tab-content');
            const canAdmin = hasAdminRights(currentUserData);
            if (tabId === 'tasks') { contentContainer.innerHTML = getTasksViewHTML(); updateAllTaskStatuses(); renderTasksTable(); setupTaskViewListeners(); } 
            else if (tabId === 'users' && canAdmin) { contentContainer.innerHTML = getUsersViewHTML(); renderUsersTable(); setupUserViewListeners(); } 
            else if (tabId === 'departments' && canAdmin) { contentContainer.innerHTML = getDepartmentsViewHTML(); renderDepartmentsTable(); setupDepartmentViewListeners(); } 
            else if (tabId === 'stats') { contentContainer.innerHTML = canAdmin ? getAdminStatsViewHTML() : getMemberStatsViewHTML(); if (canAdmin) renderAdminStats(); else renderMemberStats(); }
        };

        const getTasksViewHTML = () => {
            const canAdmin = hasAdminRights(currentUserData);
            return `<div class="bg-white p-4 rounded-lg shadow-sm mb-4"><div class="grid grid-cols-1 md:grid-cols-2 ${canAdmin ? 'lg:grid-cols-5' : 'lg:grid-cols-4'} gap-4 items-center"><input type="text" id="task-search" placeholder="TÃ¬m kiáº¿m cÃ´ng viá»‡c, vÄƒn báº£n..." class="w-full p-2 border rounded-lg ${canAdmin ? 'lg:col-span-1' : ''}"><select id="task-filter-status" class="w-full p-2 border rounded-lg"><option value="">Táº¥t cáº£ Tráº¡ng thÃ¡i</option>${['ChÆ°a báº¯t Ä‘áº§u', 'Äang thá»±c hiá»‡n', 'HoÃ n thÃ nh', 'ÄÃ£ há»§y'].map(s => `<option value="${s}">${s}</option>`).join('')}</select><select id="task-sort" class="w-full p-2 border rounded-lg"><option value="default">Sáº¯p xáº¿p máº·c Ä‘á»‹nh</option><option value="orderNumber_asc">Theo STT</option><option value="documentNumber_asc">Theo Sá»‘ vÄƒn báº£n</option></select>${canAdmin ? `<select id="task-filter-category" class="w-full p-2 border rounded-lg"><option value="">Táº¥t cáº£ Danh má»¥c</option>${TASK_CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('')}</select>` : ''}<button id="toggle-timeline-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg text-sm whitespace-nowrap">${showTimeline ? 'áº¨n' : 'Hiá»‡n'} Tiáº¿n trÃ¬nh</button></div></div><div class="flex justify-between items-center mb-4"><button id="add-task-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">+ ThÃªm CÃ´ng viá»‡c</button>${canAdmin ? `<button id="export-excel-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300">ğŸ“¥ Xuáº¥t Excel</button>` : ''}</div><div class="bg-white rounded-lg shadow-md overflow-x-auto"><table class="w-full min-w-max text-left"><thead class="bg-gray-50"></thead><tbody id="tasks-table-body"></tbody></table></div>`;
        };
        const getUsersViewHTML = () => { /* ... */ };
        const getDepartmentsViewHTML = () => { /* ... */ };
        const getAdminStatsViewHTML = () => { /* ... */ };
        const getMemberStatsViewHTML = () => { /* ... */ };
        const generateTimelineHTML = (task) => { /* ... */ };

        const renderTasksTable = () => {
            const canAdmin = hasAdminRights(currentUserData);
            const tableBody = document.querySelector('#tasks-table-body');
            if (!tableBody) return;
            const tableHead = tableBody.previousElementSibling;
            tableHead.innerHTML = `<tr><th class="p-4 font-semibold text-gray-700">STT</th><th class="p-4 font-semibold text-gray-700">CÃ´ng viá»‡c & VÄƒn báº£n</th>${canAdmin ? '<th class="p-4 font-semibold text-gray-700">GÃ¡n cho</th>' : ''}<th class="p-4 font-semibold text-gray-700">Tráº¡ng thÃ¡i</th><th class="p-4 font-semibold text-gray-700">NgÃ y</th><th class="p-4 font-semibold text-gray-700 text-center">HÃ nh Ä‘á»™ng</th></tr>`;
            const searchTerm = document.getElementById('task-search').value.toLowerCase();
            const statusFilter = document.getElementById('task-filter-status').value;
            const sortOption = document.getElementById('task-sort').value;
            let filteredTasks = canAdmin ? [...tasks] : tasks.filter(t => t.assignedTo === currentUserData.id || t.createdBy === currentUserData.id);
            filteredTasks = filteredTasks.filter(t => (t.title.toLowerCase().includes(searchTerm) || (t.documentNumber && t.documentNumber.toLowerCase().includes(searchTerm)) || (t.documentSummary && t.documentSummary.toLowerCase().includes(searchTerm))) && (!statusFilter || t.status === statusFilter));
            if (sortOption === 'orderNumber_asc') filteredTasks.sort((a, b) => (parseInt(a.orderNumber) || Infinity) - (parseInt(b.orderNumber) || Infinity));
            else if (sortOption === 'documentNumber_asc') filteredTasks.sort((a, b) => (a.documentNumber || '').localeCompare(b.documentNumber || ''));
            tableBody.innerHTML = '';
            if (filteredTasks.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${canAdmin ? 6:5}" class="text-center p-8 text-gray-500">KhÃ´ng tÃ¬m tháº¥y cÃ´ng viá»‡c nÃ o.</td></tr>`;
                return;
            }
            filteredTasks.forEach(task => {
                const assignedUser = users.find(u => u.id === task.assignedTo);
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-200 hover:bg-gray-50';
                const timelineHTML = showTimeline ? generateTimelineHTML(task) : '';
                tr.innerHTML = `<td class="p-4 align-top font-semibold text-gray-700">${task.orderNumber || ''}</td><td class="p-4 align-top"><div class="font-bold text-gray-800">${task.title}</div>${task.documentNumber ? `<div class="mt-1"><span class="font-semibold text-sm">VB:</span> <span class="text-sm text-gray-600">${task.documentNumber}</span> <button class="view-doc-btn text-blue-500 text-xs hover:underline" data-id="${task.id}">(Xem)</button></div><div class="text-sm text-gray-500 mt-1 line-clamp-2">${task.documentSummary || ''}</div>` : ''}${timelineHTML}</td>${canAdmin ? `<td class="p-4 align-top"><div class="flex items-center gap-2">${generateAvatar(assignedUser?.name, 'w-8 h-8')}<span class="text-sm">${assignedUser?.name || 'N/A'}</span></div></td>` : ''}<td class="p-4 align-top"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusClass(task.status)}">${task.status}</span></td><td class="p-4 text-sm text-gray-600 align-top"><div>BÄ: ${task.startDate || 'N/A'}</div><div>HT: ${task.endDate || 'N/A'}</div></td><td class="p-4 text-center align-top"><button data-id="${task.id}" class="edit-task-btn p-2 text-blue-600 hover:bg-blue-100 rounded-full">Sá»­a</button><button data-id="${task.id}" class="delete-task-btn p-2 text-red-600 hover:bg-red-100 rounded-full">XÃ³a</button></td>`;
                tableBody.appendChild(tr);
            });
        };
        const renderUsersTable = () => { /* ... full function ... */ };
        const renderDepartmentsTable = () => { /* ... full function ... */ };
        const renderAdminStats = () => { /* ... full function ... */ };
        const renderMemberStats = () => { /* ... full function ... */ };
        const renderStatsTaskList = (isAdmin) => { /* ... full function ... */ };

        // --- CORE LOGIC & HANDLERS ---
        const getAutoTaskStatus = (task) => { if (task.status === 'HoÃ n thÃ nh' || task.status === 'ÄÃ£ há»§y') return task.status; const start = task.startDate ? new Date(task.startDate) : null; if (start) start.setHours(0,0,0,0); const end = task.endDate ? new Date(task.endDate) : null; if (end) end.setHours(0,0,0,0); if (!start) return 'ChÆ°a báº¯t Ä‘áº§u'; if (TODAY < start) return 'ChÆ°a báº¯t Ä‘áº§u'; if (end && TODAY > end) return 'HoÃ n thÃ nh'; return 'Äang thá»±c hiá»‡n'; };
        const updateAllTaskStatuses = () => { const updates = []; tasks.forEach(task => { const oldStatus = task.status; const newStatus = getAutoTaskStatus(task); if (oldStatus !== newStatus) { updates.push(db.collection('tasks').doc(task.id).update({ status: newStatus })); } }); if (updates.length > 0) Promise.all(updates).catch(err => console.error("Error batch updating statuses:", err)); };
        const openTaskModal = (task = null) => { const canAdmin = hasAdminRights(currentUserData); const userOptions = users.map(u => `<option value="${u.id}" ${task?.assignedTo === u.id || (!task && u.id === currentUserData.id) ? 'selected' : ''}>${u.name}</option>`).join(''); const hasDocInfo = task?.documentNumber || task?.documentSummary; const modalHTML = `<div class="modal-container fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"><div class="modal-content bg-white rounded-lg shadow-2xl p-6 w-full max-w-2xl mx-4 overflow-y-auto max-h-screen"><h2 class="text-2xl font-bold mb-6 text-gray-800">${task ? 'Chá»‰nh sá»­a' : 'ThÃªm má»›i'}</h2><form id="task-form-modal"><input type="hidden" name="id" value="${task?.id || ''}"><div class="space-y-4"><div><label class="font-semibold">TiÃªu Ä‘á»</label><input type="text" name="title" class="w-full p-2 border rounded-lg" value="${task?.title || ''}" required></div><div><label class="font-semibold">MÃ´ táº£</label><textarea name="description" rows="2" class="w-full p-2 border rounded-lg">${task?.description || ''}</textarea></div><div class="border border-gray-200 rounded-lg"><button type="button" id="toggle-doc-info" class="w-full flex justify-between items-center p-3 bg-gray-50 hover:bg-gray-100"><span class="font-semibold text-gray-700">ThÃ´ng tin vÄƒn báº£n</span><svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div id="doc-info-content" class="p-4 space-y-4 ${hasDocInfo ? '' : 'hidden'}"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium">Sá»‘ thá»© tá»±</label><input type="number" name="orderNumber" class="w-full p-2 border rounded-lg" value="${task?.orderNumber || ''}"></div><div><label class="block text-sm font-medium">Sá»‘ vÄƒn báº£n</label><input type="text" name="documentNumber" class="w-full p-2 border rounded-lg" value="${task?.documentNumber || ''}"></div></div><div><label class="block text-sm font-medium">TrÃ­ch yáº¿u</label><textarea name="documentSummary" rows="2" class="w-full p-2 border rounded-lg">${task?.documentSummary || ''}</textarea></div><div><label class="block text-sm font-medium">Sá»Ÿ ngÃ nh</label><input type="text" name="implementingDepartment" class="w-full p-2 border rounded-lg" value="${task?.implementingDepartment || ''}"></div><div><label class="block text-sm font-medium">Äá» xuáº¥t VP</label><textarea name="officeProposal" rows="2" class="w-full p-2 border rounded-lg">${task?.officeProposal || ''}</textarea></div><div><label class="block text-sm font-medium">LÃ£nh Ä‘áº¡o</label><input type="text" name="leaderInCharge" class="w-full p-2 border rounded-lg" value="${task?.leaderInCharge || ''}"></div></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${canAdmin ? `<div><label class="font-semibold">GÃ¡n cho</label><select name="assignedTo" class="w-full p-2 border rounded-lg">${userOptions}</select></div>` : `<input type="hidden" name="assignedTo" value="${task?.assignedTo || currentUserData.id}">`}<div><label class="font-semibold">Danh má»¥c</label><select name="category" class="w-full p-2 border rounded-lg">${TASK_CATEGORIES.map(c => `<option value="${c}" ${task?.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="font-semibold">Tráº¡ng thÃ¡i</label><select name="status" class="w-full p-2 border rounded-lg">${['ChÆ°a báº¯t Ä‘áº§u', 'Äang thá»±c hiá»‡n', 'HoÃ n thÃ nh', 'ÄÃ£ há»§y'].map(s => `<option value="${s}" ${task?.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div><div><label class="font-semibold">Æ¯u tiÃªn</label><select name="priority" class="w-full p-2 border rounded-lg">${['Tháº¥p', 'Trung bÃ¬nh', 'Cao', 'Kháº©n cáº¥p'].map(p => `<option value="${p}" ${task?.priority === p ? 'selected' : ''}>${p}</option>`).join('')}</select></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="font-semibold">NgÃ y báº¯t Ä‘áº§u</label><input type="date" name="startDate" class="w-full p-2 border rounded-lg" value="${task?.startDate || ''}"></div><div><label class="font-semibold">NgÃ y káº¿t thÃºc</label><input type="date" name="endDate" class="w-full p-2 border rounded-lg" value="${task?.endDate || ''}"></div></div></div><div class="flex justify-end gap-4 mt-6"><button type="button" class="modal-close bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">Há»§y</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">LÆ°u</button></div></form></div></div>`; showModal(modalHTML); const toggleBtn = document.getElementById('toggle-doc-info'); toggleBtn.addEventListener('click', () => { toggleBtn.nextElementSibling.classList.toggle('hidden'); toggleBtn.querySelector('svg').classList.toggle('rotate-180'); }); attachAutoStatusListenerToForm('task-form-modal'); };
        const handleTaskSubmit = async (e) => { e.preventDefault(); const formData = new FormData(e.target); const id = formData.get('id'); const taskData = { title: formData.get('title'), description: formData.get('description'), assignedTo: formData.get('assignedTo'), category: formData.get('category'), status: formData.get('status'), priority: formData.get('priority'), startDate: formData.get('startDate'), endDate: formData.get('endDate'), orderNumber: formData.get('orderNumber'), documentNumber: formData.get('documentNumber'), documentSummary: formData.get('documentSummary'), implementingDepartment: formData.get('implementingDepartment'), officeProposal: formData.get('officeProposal'), leaderInCharge: formData.get('leaderInCharge'), }; if (id) { await db.collection('tasks').doc(id).set(taskData, { merge: true }); showNotification('Cáº­p nháº­t thÃ nh cÃ´ng!'); } else { taskData.createdBy = auth.currentUser.uid; await db.collection('tasks').add(taskData); showNotification('ThÃªm thÃ nh cÃ´ng!'); } closeModal(); };
        const deleteTask = async (taskId) => { if(confirm("XÃ³a cÃ´ng viá»‡c nÃ y?")) { await db.collection('tasks').doc(taskId).delete(); showNotification('ÄÃ£ xÃ³a.'); } };
        const showDocumentDetailModal = (taskId) => { /* ... full function ... */ };
        const openUserModal = (user = null) => { /* ... full function ... */ };
        const handleUserSubmit = async (e) => { /* ... full function ... */ };
        const deleteUser = async (userId) => { /* ... full function ... */ };
        const openDepartmentModal = (dept = null) => { /* ... full function ... */ };
        const handleDepartmentSubmit = async (e) => { /* ... full function ... */ };
        const deleteDepartment = async (deptId) => { /* ... full function ... */ };
        const exportToExcel = () => { /* ... full function ... */ };
        
        // --- EVENT LISTENER SETUP ---
        function setupGlobalListeners() {
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.body.addEventListener('click', e => {
                const target = e.target;
                if(target.closest('.edit-task-btn')) openTaskModal(tasks.find(t => t.id === target.closest('.edit-task-btn').dataset.id));
                if(target.closest('.delete-task-btn')) deleteTask(target.closest('.delete-task-btn').dataset.id);
                if(target.closest('.view-doc-btn')) showDocumentDetailModal(target.closest('.view-doc-btn').dataset.id);
                if(target.closest('.edit-user-btn')) openUserModal(users.find(u => u.id === target.closest('.edit-user-btn').dataset.id));
                if(target.closest('.delete-user-btn')) deleteUser(target.closest('.delete-user-btn').dataset.id);
                if(target.closest('.edit-department-btn')) openDepartmentModal(departments.find(d => d.id === target.closest('.edit-department-btn').dataset.id));
                if(target.closest('.delete-department-btn')) deleteDepartment(target.closest('.delete-department-btn').dataset.id);
            });
        }
        
        function setupViewSwitcherListeners() { document.querySelectorAll('.view-switcher').forEach(button => { const listener = (e) => { e.preventDefault(); showView(e.target.closest('.view-switcher').dataset.view); }; button.removeEventListener('click', listener); button.addEventListener('click', listener); }); }
        
        function setupTaskViewListeners() {
            const addTaskBtn = document.getElementById('add-task-btn'); if(addTaskBtn) addTaskBtn.addEventListener('click', () => openTaskModal());
            const exportBtn = document.getElementById('export-excel-btn'); if(exportBtn) exportBtn.addEventListener('click', exportToExcel);
            const toggleTimelineBtn = document.getElementById('toggle-timeline-btn'); if(toggleTimelineBtn) toggleTimelineBtn.addEventListener('click', () => { showTimeline = !showTimeline; renderTasksTable(); toggleTimelineBtn.textContent = `${showTimeline ? 'áº¨n' : 'Hiá»‡n'} Tiáº¿n trÃ¬nh`; toggleTimelineBtn.classList.toggle('bg-blue-100', showTimeline); toggleTimelineBtn.classList.toggle('text-blue-700', showTimeline); });
            const searchInput = document.getElementById('task-search'); if(searchInput) searchInput.addEventListener('input', renderTasksTable);
            const statusFilter = document.getElementById('task-filter-status'); if(statusFilter) statusFilter.addEventListener('change', renderTasksTable);
            const sortInput = document.getElementById('task-sort'); if(sortInput) sortInput.addEventListener('change', renderTasksTable);
            const categoryFilter = document.getElementById('task-filter-category'); if (categoryFilter) categoryFilter.addEventListener('change', renderTasksTable);
        }
        function attachAutoStatusListenerToForm(formId) {
            const form = document.getElementById(formId);
            const startDateInput = form.querySelector('[name="startDate"]');
            const endDateInput = form.querySelector('[name="endDate"]');
            const statusSelect = form.querySelector('[name="status"]');
            const updateStatus = () => { const tempTask = { startDate: startDateInput.value, endDate: endDateInput.value, status: statusSelect.value }; const newStatus = getAutoTaskStatus(tempTask); if (statusSelect.value !== newStatus && statusSelect.value !== 'HoÃ n thÃ nh' && statusSelect.value !== 'ÄÃ£ há»§y') { statusSelect.value = newStatus; } };
            startDateInput.addEventListener('change', updateStatus);
            endDateInput.addEventListener('change', updateStatus);
            form.addEventListener('submit', handleTaskSubmit);
        };
        function setupUserViewListeners() { document.getElementById('add-user-btn').addEventListener('click', () => openUserModal()); document.getElementById('user-search').addEventListener('input', renderUsersTable); }
        function setupDepartmentViewListeners() { document.getElementById('add-department-btn').addEventListener('click', () => openDepartmentModal()); }

        // --- APP INITIALIZATION ---
        const init = () => {
            setupGlobalListeners();
            updateLoggedOutUI();
            setInterval(() => {
                if(auth.currentUser){
                    console.log('Running periodic task status update...');
                    updateAllTaskStatuses();
                }
            }, 1000 * 60 * 60);
        };

        init();
    });
    </script>
</body>
</html>
